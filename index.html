<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¦å²¡æ—…äºº V4</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/torii.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        /* iOS Safe Area é©é… */
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: none; /* é˜²æ­¢ä¸‹æ‹‰é‡æ•´å¹²æ“¾ */
            -webkit-tap-highlight-color: transparent;
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ç»ç’ƒæ“¬æ…‹ Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* Checkbox å‹•ç•« */
        .check-anim:checked + div {
            text-decoration: line-through;
            color: #94a3b8;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- 1. Header (å›ºå®šé ‚éƒ¨) -->
    <header class="glass-header z-30 pt-safe-top flex-none">
        <!-- æ¨™é¡Œåˆ— -->
        <div class="px-4 py-2 flex justify-between items-center h-12">
            <div>
                <h1 class="text-lg font-bold text-slate-800 leading-tight">FUKUOKA <span class="text-blue-600">TRIP</span></h1>
                <div class="text-[10px] text-slate-500 font-mono flex gap-2">
                    <span id="clock">--:--</span> | <span id="weather"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
            </div>
            <button onclick="openSettings()" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <!-- æ»‘å‹•åˆ†é åˆ— -->
        <div class="flex overflow-x-auto no-scrollbar px-2 pb-0 space-x-1" id="tabs-container">
            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </header>

    <!-- 2. ä¸»è¦å…§å®¹å€ -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
        <!-- JS å‹•æ…‹æ¸²æŸ“å…§å®¹ -->
    </main>

    <!-- 3. FAB (æ‡¸æµ®æŒ‰éˆ•) -->
    <button onclick="handleFab()" id="fab-btn" class="fixed bottom-8 right-6 w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-500/40 flex items-center justify-center text-2xl z-40 active:scale-95 transition-transform pb-safe-bottom">
        <i class="fas fa-plus"></i>
    </button>

    <!-- ================= MODALS ================= -->

    <!-- Modal: æ–°å¢/ç·¨è¼¯è¡Œç¨‹ -->
    <div id="modal-itinerary" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeModal('modal-itinerary')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe-bottom" id="sheet-itinerary">
            <div class="p-6">
                <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span id="itin-modal-title">è¡Œç¨‹</span>
                    <span id="itin-badge" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500"></span>
                </h3>
                
                <form id="form-itinerary" class="space-y-4">
                    <input type="hidden" id="itin-id">
                    <div class="flex gap-3">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-slate-400 mb-1">æ™‚é–“</label>
                            <input type="time" id="itin-time" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-mono">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">åˆ†é¡</label>
                            <select id="itin-category" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none">
                                <option value="spot">ğŸ“¸ æ™¯é»</option>
                                <option value="food">ğŸœ ç¾é£Ÿ</option>
                                <option value="transport">ğŸš† äº¤é€š</option>
                                <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="hotel">ğŸ¨ ä½å®¿</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <input type="text" id="itin-title" placeholder="æ¨™é¡Œ (ä¾‹å¦‚: ç†Šæœ¬åŸ)" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                    </div>
                    <div>
                        <input type="url" id="itin-url" placeholder="Google Maps é€£çµ (é¸å¡«)" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none text-sm">
                    </div>
                    <div>
                        <textarea id="itin-note" rows="2" placeholder="å‚™è¨»..." class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none text-sm"></textarea>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="deleteItinerary()" id="btn-del-itin" class="hidden px-4 bg-red-50 text-red-500 rounded-xl font-bold"><i class="fas fa-trash"></i></button>
                        <button type="button" onclick="saveItinerary()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: è¨˜å¸³ -->
    <div id="modal-expense" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeModal('modal-expense')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe-bottom" id="sheet-expense">
            <div class="p-6">
                <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4">è¨˜ä¸€ç­†</h3>
                <form class="space-y-4">
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">æ—¥æœŸæ­¸å±¬</label>
                            <select id="exp-day" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 font-bold text-slate-700"></select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">ä»˜æ¬¾äºº</label>
                            <select id="exp-payer" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">é‡‘é¡ (JPY)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-slate-400 font-bold">Â¥</span>
                            <input type="number" id="exp-amount" placeholder="0" class="w-full pl-8 p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-yellow-500 outline-none font-mono font-bold text-xl">
                        </div>
                    </div>
                    <div>
                        <input type="text" id="exp-item" placeholder="é …ç›® (ä¾‹å¦‚: æ‹‰éºµ)" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none">
                    </div>
                    <button type="button" onclick="saveExpense()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg mt-2">ç¢ºèªè¨˜å¸³</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: å¾…è¾¦äº‹é … -->
    <div id="modal-todo" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeModal('modal-todo')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe-bottom" id="sheet-todo">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">æ–°å¢å¾…è¾¦</h3>
                <input type="text" id="todo-input" placeholder="è¦åšä»€éº¼..." class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 mb-4 outline-none">
                <button onclick="saveTodo()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Modal: è¨­å®š -->
    <div id="modal-settings" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ—…ä¼´åå–® (é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="set-companions" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">åŒ¯ç‡ (JPY â†’ TWD)</label>
                    <input type="number" step="0.001" id="set-rate" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <hr class="border-slate-100 my-2">
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold"><i class="fas fa-file-export mr-1"></i>å‚™ä»½ä»£ç¢¼</button>
                    <button onclick="importData()" class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold"><i class="fas fa-file-import mr-1"></i>åŒ¯å…¥ä»£ç¢¼</button>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <button onclick="resetData()" class="text-xs text-red-400">é‡ç½®è³‡æ–™</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold text-sm">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // --- è¨­å®šèˆ‡å¸¸æ•¸ ---
        const CONFIG = {
            storageKey: 'fukuoka_trip_v4',
            tabs: [
                { id: 'todo', label: 'ğŸ“‹ å¾…è¾¦', type: 'todo' },
                { id: 'd1', label: '12/31', full: '12/31 (äºŒ)', type: 'day' },
                { id: 'd2', label: '1/1', full: '1/1 (ä¸‰)', type: 'day' },
                { id: 'd3', label: '1/2', full: '1/2 (å››)', type: 'day' },
                { id: 'd4', label: '1/3', full: '1/3 (äº”)', type: 'day' },
                { id: 'd5', label: '1/4', full: '1/4 (å…­)', type: 'day' },
                { id: 'd6', label: '1/5', full: '1/5 (æ—¥)', type: 'day' },
                { id: 'money', label: 'ğŸ’° åˆ†å¸³', type: 'expense' }
            ],
            icons: {
                transport: { icon: 'fa-train', color: 'text-blue-500', bg: 'bg-blue-100' },
                food: { icon: 'fa-utensils', color: 'text-orange-500', bg: 'bg-orange-100' },
                spot: { icon: 'fa-camera', color: 'text-green-500', bg: 'bg-green-100' },
                shop: { icon: 'fa-shopping-bag', color: 'text-pink-500', bg: 'bg-pink-100' },
                hotel: { icon: 'fa-bed', color: 'text-purple-500', bg: 'bg-purple-100' },
                default: { icon: 'fa-map-pin', color: 'text-slate-500', bg: 'bg-slate-100' }
            }
        };

        // --- é è¨­è³‡æ–™ (ä½ çš„è¡Œç¨‹) ---
        const defaultData = {
            checklist: [
                { id: 1, text: "é ç´„ Cinnamoroll Cafe (1/4 å‚æ™š)", done: false },
                { id: 2, text: "é ç´„ç§Ÿè»Š (1/2 09:00 å–)", done: false },
                { id: 3, text: "è³¼è²· BOSS Eï½¥ZO FUKUOKA é–€ç¥¨", done: false },
                { id: 4, text: "è³¼è²· JR Pass / é è¨‚æ–°å¹¹ç·š", done: false },
                { id: 5, text: "ç¢ºèªå¹´æœ«å¹´å§‹é¤å»³ç‡Ÿæ¥­æ™‚é–“", done: false }
            ],
            itinerary: [
                // Day 1
                { id: 101, day: 'd1', time: '10:00', category: 'transport', title: 'æŠµé”ç¦å²¡æ©Ÿå ´', note: 'æ­åœ°éµè‡³åšå¤š (å¯„è¡Œæ)', url: '' },
                { id: 102, day: 'd1', time: '12:00', category: 'food', title: 'åšå¤šè»Šç«™å•†åœˆ', note: 'AMU PLAZA åˆé¤', url: '' },
                { id: 103, day: 'd1', time: '14:00', category: 'spot', title: 'BOSS Eï½¥ZO FUKUOKA', note: 'çµ•æ™¯ä¸‰å…„å¼Ÿ / teamLab', url: '' },
                { id: 104, day: 'd1', time: '17:00', category: 'spot', title: 'ç¦å²¡å¡”', note: 'å¤•é™½è½‰å¤œæ™¯', url: '' },
                { id: 105, day: 'd1', time: '19:00', category: 'food', title: 'ä¸­æ´²å±‹å°è¡—', note: 'è·¨å¹´æ°£æ°›', url: '' },
                { id: 106, day: 'd1', time: '21:00', category: 'hotel', title: 'åšå¤šè»Šç«™é™„è¿‘é£¯åº—', note: 'Check-in', url: '' },
                // Day 2
                { id: 201, day: 'd2', time: '09:00', category: 'transport', title: 'æ­æ–°å¹¹ç·š (åšå¤šâ†’ç†Šæœ¬)', note: '', url: '' },
                { id: 202, day: 'd2', time: '10:00', category: 'spot', title: 'ç†Šæœ¬åŸ & åŠ è—¤ç¥ç¤¾', note: 'æ–°å¹´åˆè©£', url: '' },
                { id: 203, day: 'd2', time: '12:00', category: 'food', title: 'æ«»ä¹‹é¦¬å ´ åŸå½©è‹‘', note: 'é¦¬è‚‰å¯æ¨‚é¤…ã€æµ·è†½å¯æ¨‚é¤…', url: '' },
                { id: 204, day: 'd2', time: '14:00', category: 'transport', title: 'æ­æ–°å¹¹ç·šè¿”å›åšå¤š', note: '', url: '' },
                { id: 205, day: 'd2', time: '16:00', category: 'spot', title: 'æ«›ç”°ç¥ç¤¾', note: 'çœ‹å·¨å‹é£¾å±±ç¬ ', url: '' },
                { id: 206, day: 'd2', time: '18:00', category: 'food', title: 'åšå¤šå¸‚å€æ™šé¤', note: 'ç™¾è²¨å…§é¤å»³ (ç‰›è…¸é‹)', url: '' },
                // Day 3
                { id: 301, day: 'd3', time: '09:00', category: 'transport', title: 'åšå¤šè»Šç«™å–è»Š', note: 'ç§Ÿè»Šé–‹å§‹', url: '' },
                { id: 302, day: 'd3', time: '10:30', category: 'spot', title: 'å°å€‰åŸ', note: '', url: '' },
                { id: 303, day: 'd3', time: '12:00', category: 'food', title: 'æ—¦éå¸‚å ´ / é­šç”ºéŠ€å¤©è¡—', note: 'åˆé¤', url: '' },
                { id: 304, day: 'd3', time: '14:00', category: 'spot', title: 'é–€å¸æ¸¯æ‡·èˆŠå€', note: 'èˆŠé–€å¸ç¨…é—œã€è—ç¿¼åŠæ©‹', url: '' },
                { id: 305, day: 'd3', time: '15:30', category: 'spot', title: 'å’Œå¸ƒåˆˆç¥ç¤¾', note: 'é—œé–€å¤§æ©‹çµ•æ™¯', url: '' },
                { id: 306, day: 'd3', time: '18:00', category: 'food', title: 'ä¼½å“©æœ¬èˆ—', note: 'é–€å¸æ¸¯ç„—çƒ¤å’–å“©', url: '' },
                { id: 307, day: 'd3', time: '20:00', category: 'hotel', title: 'å›åšå¤šæˆ–ä½åŒ—ä¹å·', note: '', url: '' },
                // Day 4
                { id: 401, day: 'd4', time: '07:30', category: 'transport', title: 'é–‹è»Šå‡ºç™¼', note: 'å‰å¾€åˆ¥åºœ', url: '' },
                { id: 402, day: 'd4', time: '09:40', category: 'spot', title: 'ä¹å·è‡ªç„¶å‹•ç‰©åœ’', note: 'æ¶ Jungle Bus ç¥¨', url: '' },
                { id: 403, day: 'd4', time: '14:00', category: 'spot', title: 'åˆ¥åºœæ˜ç¤¬æº«æ³‰ï¼šæ¹¯ä¹‹é‡Œ', note: 'éœ²å¤©é¢¨å‘‚', url: '' },
                { id: 404, day: 'd4', time: '15:30', category: 'food', title: 'å²¡æœ¬å±‹è³£åº—', note: 'åœ°ç„è’¸å¸ƒä¸', url: '' },
                { id: 405, day: 'd4', time: '17:00', category: 'transport', title: 'é–‹è»Šè¿”å›åšå¤š', note: 'æ™šé¤å¾Œé‚„è»Š', url: '' },
                // Day 5
                { id: 501, day: 'd5', time: '10:00', category: 'spot', title: 'æµ·ä¹‹ä¸­é“æµ·æ¿±å…¬åœ’', note: 'å‹•ç‰©ä¹‹æ£® / èŠ±æµ·', url: '' },
                { id: 502, day: 'd5', time: '17:00', category: 'spot', title: 'åšå¤šé‹æ²³åŸ', note: 'çœ‹å™´æ°´ç§€', url: '' },
                { id: 503, day: 'd5', time: '18:00', category: 'food', title: 'Cinnamoroll Cafe', note: 'âš ï¸ é ç´„åˆ¶', url: '' },
                // Day 6
                { id: 601, day: 'd6', time: '10:00', category: 'shop', title: 'LaLaport ç¦å²¡', note: 'å¯¦é«”é‹¼å½ˆ', url: '' },
                { id: 602, day: 'd6', time: '14:00', category: 'transport', title: 'å‰å¾€ç¦å²¡æ©Ÿå ´', note: 'æº–å‚™å›ç¨‹', url: '' }
            ],
            expenses: [],
            settings: { companions: ["æˆ‘", "æ—…ä¼´A"], rate: 0.22 }
        };

        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let appData = null;
        let currentTabId = 'todo';

        // --- åˆå§‹åŒ– ---
        function init() {
            try {
                const stored = localStorage.getItem(CONFIG.storageKey);
                appData = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultData));
                if (!appData.itinerary) throw new Error("Data structure invalid");
            } catch (e) {
                console.warn("Resetting data due to error:", e);
                appData = JSON.parse(JSON.stringify(defaultData));
                saveData();
            }

            renderTabs();
            switchTab(CONFIG.tabs[0].id); // é è¨­é–‹å•Ÿç¬¬ä¸€å€‹åˆ†é 
            startClock();
            fetchWeather();
        }

        function saveData() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData));
        }

        // --- æ¸²æŸ“ï¼šåˆ†é  (Tabs) ---
        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = CONFIG.tabs.map(tab => `
                <button onclick="switchTab('${tab.id}')" 
                    class="tab-btn flex-none px-4 py-3 text-sm font-bold transition-all border-b-2 border-transparent outline-none ${tab.id === 'money' ? 'text-yellow-600' : 'text-slate-400'}" 
                    data-id="${tab.id}">
                    ${tab.label}
                </button>
            `).join('');
        }

        function switchTab(id) {
            currentTabId = id;
            
            // æ›´æ–° Tab æ¨£å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.id === id;
                if(isActive) {
                   btn.className = `tab-btn flex-none px-4 py-3 text-sm font-bold transition-all border-b-2 outline-none ${id === 'money' ? 'border-yellow-500 text-yellow-700 bg-yellow-50/50' : 'border-blue-600 text-blue-600 bg-blue-50/50'}`;
                   btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                   btn.className = `tab-btn flex-none px-4 py-3 text-sm font-bold transition-all border-b-2 border-transparent text-slate-400 outline-none`;
                }
            });

            // æ›´æ–° FAB æ¨£å¼
            const fab = document.getElementById('fab-btn');
            if (id === 'money') {
                fab.className = fab.className.replace('bg-blue-600', 'bg-slate-800').replace('shadow-blue-500/40', 'shadow-slate-500/40');
            } else {
                fab.className = fab.className.replace('bg-slate-800', 'bg-blue-600').replace('shadow-slate-500/40', 'shadow-blue-500/40');
            }

            // æ¸²æŸ“å…§å®¹
            renderContent();
        }

        // --- æ¸²æŸ“ï¼šä¸»å…§å®¹ ---
        function renderContent() {
            const container = document.getElementById('main-content');
            const tabConfig = CONFIG.tabs.find(t => t.id === currentTabId);
            container.innerHTML = `<div class="h-2"></div>`; // Spacer

            if (tabConfig.type === 'todo') {
                renderChecklist(container);
            } else if (tabConfig.type === 'expense') {
                renderExpense(container);
            } else {
                renderItinerary(container, currentTabId);
            }
        }

        // --- æ¨¡çµ„ï¼šå¾…è¾¦æ¸…å–® (Checklist) ---
        function renderChecklist(container) {
            if (appData.checklist.length === 0) {
                container.innerHTML += `<div class="text-center text-slate-400 mt-10">ç„¡å¾…è¾¦äº‹é …</div>`;
                return;
            }
            
            const list = document.createElement('div');
            list.className = 'space-y-3';
            
            appData.checklist.forEach(item => {
                const row = document.createElement('label');
                row.className = 'flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 cursor-pointer active:scale-[0.99] transition-transform';
                row.innerHTML = `
                    <input type="checkbox" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 check-anim" 
                        ${item.done ? 'checked' : ''} onchange="toggleTodo(${item.id})">
                    <div class="ml-3 flex-1 text-slate-700 font-medium ${item.done ? 'line-through text-slate-400' : ''}">${item.text}</div>
                    <button onclick="deleteTodo(event, ${item.id})" class="text-slate-300 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(row);
            });
            container.appendChild(list);
        }

        function toggleTodo(id) {
            const item = appData.checklist.find(i => i.id === id);
            if (item) {
                item.done = !item.done;
                saveData();
                renderContent(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ¨£å¼
            }
        }

        function saveTodo() {
            const input = document.getElementById('todo-input');
            if (input.value.trim()) {
                appData.checklist.push({ id: Date.now(), text: input.value, done: false });
                saveData();
                input.value = '';
                closeModal('modal-todo');
                renderContent();
            }
        }

        function deleteTodo(e, id) {
            e.preventDefault();
            if(confirm('åˆªé™¤æ­¤é …ç›®ï¼Ÿ')) {
                appData.checklist = appData.checklist.filter(i => i.id !== id);
                saveData();
                renderContent();
            }
        }

        // --- æ¨¡çµ„ï¼šè¡Œç¨‹ (Itinerary) ---
        function renderItinerary(container, dayId) {
            const items = appData.itinerary
                .filter(i => i.day === dayId)
                .sort((a, b) => a.time.localeCompare(b.time));

            // é¡¯ç¤ºè©²æ—¥æœŸçš„å®Œæ•´æ¨™é¡Œ
            const dayLabel = CONFIG.tabs.find(t => t.id === dayId).full;
            container.innerHTML += `
                <div class="sticky top-0 z-10 bg-[#f1f5f9]/95 backdrop-blur py-2 mb-2 flex items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-200 px-2 py-1 rounded">${dayLabel}</span>
                    <div class="h-px bg-slate-200 flex-1 ml-3"></div>
                </div>
            `;

            if (items.length === 0) {
                container.innerHTML += `<div class="text-center text-slate-300 mt-10"><i class="fas fa-wind text-4xl mb-2"></i><br>å°šç„¡è¡Œç¨‹</div>`;
                return;
            }

            items.forEach(item => {
                const style = CONFIG.icons[item.category] || CONFIG.icons.default;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl p-4 mb-3 shadow-sm border border-slate-100 flex gap-4 relative group active:scale-[0.98] transition-transform';
                card.onclick = (e) => {
                    if(!e.target.closest('button')) openItineraryModal(item.id);
                };

                card.innerHTML = `
                    <div class="flex flex-col items-center pt-1 w-14 border-r border-slate-50 pr-2">
                        <span class="text-sm font-bold font-mono text-slate-600">${item.time}</span>
                        <div class="mt-2 w-8 h-8 rounded-full ${style.bg} ${style.color} flex items-center justify-center text-xs shadow-sm">
                            <i class="fas ${style.icon}"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight truncate">${item.title}</h3>
                        ${item.note ? `<p class="text-xs text-slate-400 mt-1 line-clamp-2">${item.note}</p>` : ''}
                        
                        ${item.url ? `
                            <button onclick="window.open('${item.url}', '_blank')" class="mt-2 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-bold flex items-center gap-1 hover:bg-blue-100 transition-colors">
                                <i class="fas fa-location-arrow"></i> å°èˆª
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- æ¨¡çµ„ï¼šåˆ†å¸³ (Expense) ---
        function renderExpense(container) {
            // 1. è¨ˆç®—
            let totalJPY = 0;
            const balances = {};
            appData.settings.companions.forEach(p => balances[p] = 0);

            appData.expenses.forEach(e => {
                totalJPY += e.amount;
                const twd = Math.round(e.amount * appData.settings.rate);
                balances[e.payer] += twd;
                const share = twd / appData.settings.companions.length;
                appData.settings.companions.forEach(p => balances[p] -= share);
            });
            const totalTWD = Math.round(totalJPY * appData.settings.rate);

            // 2. çµç®—å»ºè­°ç®—æ³•
            let settlements = [];
            let debtors = [], creditors = [];
            for (const [p, amt] of Object.entries(balances)) {
                if (amt < -1) debtors.push({ p, amt });
                if (amt > 1) creditors.push({ p, amt });
            }
            debtors.sort((a,b) => a.amt - b.amt);
            creditors.sort((a,b) => b.amt - a.amt);
            
            let i=0, j=0;
            while(i < debtors.length && j < creditors.length) {
                const val = Math.min(Math.abs(debtors[i].amt), creditors[j].amt);
                settlements.push(`${debtors[i].p} â†’ ${creditors[j].p} : $${Math.round(val)}`);
                debtors[i].amt += val; creditors[j].amt -= val;
                if(Math.abs(debtors[i].amt)<1) i++;
                if(creditors[j].amt<1) j++;
            }

            // 3. é ‚éƒ¨ç¸½è¦½
            const dashboard = document.createElement('div');
            dashboard.className = 'bg-slate-800 text-white p-5 rounded-2xl shadow-lg mb-6';
            dashboard.innerHTML = `
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase tracking-wider">ç¸½æ”¯å‡º (TWD)</p>
                        <h2 class="text-3xl font-mono font-bold">NT$ ${totalTWD.toLocaleString()}</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400">åŒ¯ç‡</p>
                        <p class="font-mono font-bold">${appData.settings.rate}</p>
                    </div>
                </div>
                <div class="pt-3 border-t border-slate-700 space-y-1">
                    ${settlements.length ? settlements.map(s => `<div class="text-xs font-mono text-yellow-400">${s}</div>`).join('') : '<div class="text-xs text-slate-500">ç›®å‰çµæ¸…</div>'}
                </div>
            `;
            container.appendChild(dashboard);

            // 4. åˆ—è¡¨
            [...appData.expenses].reverse().forEach(exp => {
                const dayLabel = CONFIG.tabs.find(t => t.id === exp.dayId)?.label || 'å…¶ä»–';
                const row = document.createElement('div');
                row.className = 'bg-white p-3 rounded-xl border border-slate-100 mb-2 flex justify-between items-center shadow-sm';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-center w-10">
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold">${dayLabel}</span>
                            <div class="mt-1 w-6 h-6 rounded-full bg-slate-800 text-white text-[10px] flex items-center justify-center">${exp.payer.charAt(0)}</div>
                        </div>
                        <div>
                            <div class="font-bold text-slate-800 text-sm">${exp.item}</div>
                            <div class="text-xs text-slate-400">Â¥${exp.amount.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="text-right font-mono font-bold text-slate-700 text-sm">NT$${Math.round(exp.amount * appData.settings.rate)}</div>
                `;
                // é•·æŒ‰åˆªé™¤
                row.onclick = () => { if(confirm(`åˆªé™¤ ${exp.item}?`)) { appData.expenses = appData.expenses.filter(x => x.id !== exp.id); saveData(); renderContent(); }};
                container.appendChild(row);
            });
        }

        // --- æ“ä½œé‚è¼¯ ---
        function handleFab() {
            if (currentTabId === 'todo') {
                document.getElementById('modal-todo').classList.remove('hidden');
                setTimeout(() => document.getElementById('sheet-todo').classList.remove('translate-y-full'), 10);
            } else if (currentTabId === 'money') {
                openExpenseModal();
            } else {
                openItineraryModal();
            }
        }

        function openItineraryModal(id = null) {
            const modal = document.getElementById('modal-itinerary');
            const sheet = document.getElementById('sheet-itinerary');
            const currentDayTab = CONFIG.tabs.find(t => t.id === currentTabId);
            
            document.getElementById('itin-badge').innerText = currentDayTab.full;
            
            if (id) {
                const item = appData.itinerary.find(i => i.id === id);
                document.getElementById('itin-modal-title').innerText = "ç·¨è¼¯è¡Œç¨‹";
                document.getElementById('itin-id').value = id;
                document.getElementById('itin-time').value = item.time;
                document.getElementById('itin-category').value = item.category;
                document.getElementById('itin-title').value = item.title;
                document.getElementById('itin-url').value = item.url || '';
                document.getElementById('itin-note').value = item.note || '';
                document.getElementById('btn-del-itin').classList.remove('hidden');
            } else {
                document.getElementById('itin-modal-title').innerText = "æ–°å¢è¡Œç¨‹";
                document.getElementById('form-itinerary').reset();
                document.getElementById('itin-id').value = '';
                document.getElementById('itin-time').value = '10:00';
                document.getElementById('btn-del-itin').classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => sheet.classList.remove('translate-y-full'), 10);
        }

        function saveItinerary() {
            const id = document.getElementById('itin-id').value;
            const title = document.getElementById('itin-title').value;
            if(!title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');

            const item = {
                id: id ? parseInt(id) : Date.now(),
                day: currentTabId,
                time: document.getElementById('itin-time').value,
                category: document.getElementById('itin-category').value,
                title: title,
                url: document.getElementById('itin-url').value,
                note: document.getElementById('itin-note').value
            };

            if(id) {
                const idx = appData.itinerary.findIndex(i => i.id == id);
                if(idx > -1) appData.itinerary[idx] = item;
            } else {
                appData.itinerary.push(item);
            }
            saveData();
            closeModal('modal-itinerary');
            renderContent();
        }

        function deleteItinerary() {
            const id = parseInt(document.getElementById('itin-id').value);
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                appData.itinerary = appData.itinerary.filter(i => i.id !== id);
                saveData();
                closeModal('modal-itinerary');
                renderContent();
            }
        }

        function openExpenseModal() {
            const modal = document.getElementById('modal-expense');
            const sheet = document.getElementById('sheet-expense');
            
            // Populate Days
            const days = CONFIG.tabs.filter(t => t.type === 'day');
            document.getElementById('exp-day').innerHTML = days.map(d => `<option value="${d.id}">${d.full}</option>`).join('');
            
            // Populate Payers
            document.getElementById('exp-payer').innerHTML = appData.settings.companions.map(p => `<option value="${p}">${p}</option>`).join('');
            
            // Reset fields
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-item').value = '';
            
            modal.classList.remove('hidden');
            setTimeout(() => sheet.classList.remove('translate-y-full'), 10);
        }

        function saveExpense() {
            const amount = parseInt(document.getElementById('exp-amount').value);
            const item = document.getElementById('exp-item').value;
            if(!amount || !item) return alert('è«‹å®Œæ•´å¡«å¯«');

            appData.expenses.push({
                id: Date.now(),
                dayId: document.getElementById('exp-day').value,
                payer: document.getElementById('exp-payer').value,
                amount, item
            });
            saveData();
            closeModal('modal-expense');
            renderContent();
        }

        // --- è¨­å®šèˆ‡å·¥å…· ---
        function openSettings() {
            document.getElementById('set-companions').value = appData.settings.companions.join(',');
            document.getElementById('set-rate').value = appData.settings.rate;
            document.getElementById('modal-settings').classList.remove('hidden');
        }

        function saveSettings() {
            const comps = document.getElementById('set-companions').value.split(',').map(s=>s.trim()).filter(s=>s);
            if(comps.length === 0) return alert('è‡³å°‘éœ€ä¸€ä½æ—…ä¼´');
            appData.settings.companions = comps;
            appData.settings.rate = parseFloat(document.getElementById('set-rate').value);
            saveData();
            closeModal('modal-settings');
            if(currentTabId === 'money') renderContent();
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            const sheet = modal.querySelector('div[id^="sheet-"]');
            if(sheet) sheet.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function resetData() {
            if(confirm('ç¢ºå®šé‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚')) {
                localStorage.removeItem(CONFIG.storageKey);
                location.reload();
            }
        }

        function exportData() {
            const code = btoa(unescape(encodeURIComponent(JSON.stringify(appData))));
            prompt("è«‹è¤‡è£½ä»£ç¢¼åˆ†äº«çµ¦æ—…ä¼´ï¼š", code);
        }

        function importData() {
            const code = prompt("è«‹è²¼ä¸Šä»£ç¢¼ï¼š");
            if(code) {
                try {
                    appData = JSON.parse(decodeURIComponent(escape(atob(code))));
                    saveData();
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                    location.reload();
                } catch(e) { alert('ä»£ç¢¼ç„¡æ•ˆ'); }
            }
        }

        // --- ç³»çµ±åŠŸèƒ½ ---
        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            };
            setInterval(update, 1000);
            update();
        }

        async function fetchWeather() {
            try {
                // ç¦å²¡åº§æ¨™
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5904&longitude=130.4017&current_weather=true&timezone=Asia%2FTokyo');
                const data = await res.json();
                document.getElementById('weather').innerHTML = `${Math.round(data.current_weather.temperature)}Â°C`;
            } catch {
                document.getElementById('weather').innerText = 'N/A';
            }
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
