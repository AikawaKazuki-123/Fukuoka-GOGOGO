<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fukuoka Travel Pro</title>
    
    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/torii.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        /* iOS Safe Area & Base */
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Transport Connector Style */
        .connector-line {
            background: rgba(241, 245, 249, 0.9); /* slate-100 */
            border: 1px solid rgba(203, 213, 225, 0.6); /* slate-300 */
            position: relative;
        }
        .connector-line::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 23px; /* Align with timeline */
            width: 2px;
            height: 10px;
            background: rgba(203, 213, 225, 0.8);
            z-index: 0;
        }
        .connector-line::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 23px;
            width: 2px;
            height: 10px;
            background: rgba(203, 213, 225, 0.8);
            z-index: 0;
        }

        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes pulse-border { 0% { border-color: rgba(59, 130, 246, 0.5); } 50% { border-color: rgba(59, 130, 246, 1); box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); } 100% { border-color: rgba(59, 130, 246, 0.5); } }
        .ai-alert { animation: pulse-border 2s infinite; }
    </style>
</head>
<body class="h-screen w-screen relative text-slate-800">

    <!-- 0. Dynamic Background -->
    <div id="app-bg" class="absolute inset-0 bg-cover bg-center bg-no-repeat z-0 transition-all duration-700 ease-in-out" 
         style="background-image: url('https://images.unsplash.com/photo-1570783852028-251f28b49749?q=80&w=2000&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-brightness-95"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center glass-panel">
        <i class="fas fa-torii-gate text-5xl text-blue-600 mb-4 animate-bounce"></i>
        <p class="text-slate-600 font-bold tracking-widest animate-pulse">SYNCING...</p>
    </div>

    <!-- 1. Main Container -->
    <div class="relative z-10 h-full flex flex-col">
        
        <!-- Header Section -->
        <header class="pt-safe-top pb-2 px-4 flex-none">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-white drop-shadow-md tracking-tight">Fukuoka <span class="font-light">Pro</span></h1>
                    <button onclick="changeRoom()" class="text-[10px] text-white/80 bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm hover:bg-white/30 transition">
                        ID: <span id="room-display" class="font-mono">LOADING</span> <i class="fas fa-pen ml-1"></i>
                    </button>
                </div>
                <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md text-white hover:bg-white/40 flex items-center justify-center transition-all shadow-lg border border-white/30">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>

            <!-- Weather Widget -->
            <div id="weather-widget" class="glass-panel rounded-2xl p-3 mb-2 hidden">
                <div class="flex items-center justify-between mb-2 px-1">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-red-500"></i>
                        <span class="text-xs font-bold text-slate-600">ç¦å²¡å¸‚</span>
                    </div>
                    <span class="text-xs text-slate-400" id="weather-updated">Update just now</span>
                </div>
                <div class="flex overflow-x-auto no-scrollbar gap-4 pb-1" id="weather-scroll"></div>
            </div>

            <!-- Tabs -->
            <div class="flex overflow-x-auto no-scrollbar gap-2 pb-1" id="tabs-container"></div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar px-4 pb-24 space-y-3">
            <!-- JS Injected -->
        </main>

        <!-- FAB -->
        <button onclick="handleFab()" id="fab-btn" class="fixed bottom-8 right-6 w-14 h-14 bg-blue-600/90 backdrop-blur text-white rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-2xl z-40 active:scale-90 transition-transform border border-white/20 pb-safe-bottom">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Itinerary Modal -->
    <div id="modal-itinerary" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal('modal-itinerary')"></div>
        <div class="absolute bottom-0 inset-x-0 glass-panel rounded-t-[2rem] transform transition-transform duration-300 translate-y-full flex flex-col max-h-[90vh]" id="sheet-itinerary">
            
            <div class="p-6 overflow-y-auto no-scrollbar pb-safe-bottom">
                <div class="w-12 h-1.5 bg-slate-300/50 rounded-full mx-auto mb-6"></div>
                
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800" id="itin-modal-title">è¡Œç¨‹ç´°ç¯€</h3>
                    <span id="itin-badge" class="px-2 py-1 bg-blue-100 text-blue-600 text-xs font-bold rounded-lg">Day 1</span>
                </div>

                <form id="form-itinerary" class="space-y-4">
                    <input type="hidden" id="itin-id">
                    
                    <!-- Basic Info -->
                    <div class="flex gap-3">
                        <div class="w-1/3">
                            <label class="text-xs font-bold text-slate-500 ml-1">æ™‚é–“</label>
                            <input type="time" id="itin-time" class="w-full mt-1 p-3 bg-white/50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none font-mono">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-500 ml-1">åˆ†é¡</label>
                            <select id="itin-category" onchange="toggleCategoryFields()" class="w-full mt-1 p-3 bg-white/50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none">
                                <option value="spot">ğŸ“¸ æ™¯é» (Spot)</option>
                                <option value="food">ğŸœ ç¾é£Ÿ (Food)</option>
                                <option value="flight">âœˆï¸ é£›æ©Ÿ (Flight)</option>
                                <option value="transport">ğŸš† äº¤é€š (Transport)</option>
                                <option value="shop">ğŸ›ï¸ è³¼ç‰© (Shop)</option>
                                <option value="hotel">ğŸ¨ ä½å®¿ (Hotel)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Title / Route -->
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1" id="lbl-title">æ¨™é¡Œ / åç¨±</label>
                        <input type="text" id="itin-title" placeholder="åœ°é»åç¨±" class="w-full mt-1 p-3 bg-white/50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none font-bold text-lg">
                    </div>

                    <!-- Transport Fields (Connector) -->
                    <div id="field-transport" class="hidden bg-slate-100/70 p-3 rounded-xl border border-slate-200 space-y-3">
                        <div class="flex gap-2 items-center">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">From</label>
                                <input type="text" id="itin-from" placeholder="å‡ºç™¼åœ°" class="w-full p-2 bg-white rounded-lg text-sm font-bold">
                            </div>
                            <i class="fas fa-arrow-right text-slate-400 mt-4"></i>
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">To</label>
                                <input type="text" id="itin-to" placeholder="ç›®çš„åœ°" class="w-full p-2 bg-white rounded-lg text-sm font-bold">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Cost (JPY)</label>
                            <input type="number" id="itin-cost" placeholder="0" class="w-full p-2 bg-white rounded-lg text-sm font-mono">
                        </div>
                    </div>

                    <!-- Flight Fields -->
                    <div id="field-flight" class="hidden grid grid-cols-2 gap-3 bg-teal-50/70 p-3 rounded-xl border border-teal-100">
                        <div>
                            <label class="text-xs font-bold text-teal-600 ml-1">èˆªç­ä»£è™Ÿ</label>
                            <input type="text" id="itin-flight" placeholder="BR106" class="w-full mt-1 p-2 bg-white border border-teal-100 rounded-xl text-sm font-mono uppercase">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-teal-600 ml-1">èˆªå»ˆ</label>
                            <input type="text" id="itin-terminal" placeholder="Intl / T2" class="w-full mt-1 p-2 bg-white border border-teal-100 rounded-xl text-sm">
                        </div>
                    </div>

                    <!-- Hotel Fields -->
                    <div id="field-hotel" class="hidden grid grid-cols-2 gap-3 bg-purple-50/70 p-3 rounded-xl border border-purple-100">
                        <div>
                            <label class="text-xs font-bold text-purple-600 ml-1">Check-in</label>
                            <input type="time" id="itin-checkin" class="w-full mt-1 p-2 bg-white border border-purple-100 rounded-xl text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-purple-600 ml-1">Booking ID</label>
                            <input type="text" id="itin-booking" class="w-full mt-1 p-2 bg-white border border-purple-100 rounded-xl text-sm font-mono">
                        </div>
                    </div>

                    <!-- Map Code Section (For Spot/Food/Hotel) -->
                    <div id="field-map" class="bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                        <label class="text-[10px] font-bold text-blue-500 uppercase tracking-wider mb-1 block">Location Info</label>
                        <div class="flex gap-2">
                            <div class="flex-1 relative">
                                <i class="fas fa-map-pin absolute left-3 top-3.5 text-blue-300"></i>
                                <input type="text" id="itin-mapcode" placeholder="Map Code" class="w-full pl-9 p-3 bg-white border border-slate-200 rounded-xl font-mono text-sm focus:outline-none focus:border-blue-400">
                            </div>
                            <button type="button" onclick="searchMapCode()" class="w-12 bg-blue-600 text-white rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- URL Input (Moved Out to Global) -->
                    <div class="relative">
                        <i class="fas fa-link absolute left-3 top-3.5 text-slate-400"></i>
                        <input type="url" id="itin-url" placeholder="Google Maps é€£çµ / ç›¸é—œç¶²å€" class="w-full pl-9 p-3 bg-white/50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-mono text-blue-600">
                    </div>

                    <!-- Plan B Toggle -->
                    <div class="border-t border-slate-200 pt-3">
                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                            <input type="checkbox" id="itin-hasPlanB" class="w-4 h-4 text-orange-500 rounded focus:ring-orange-500" onchange="togglePlanB()">
                            <span class="text-sm font-bold text-slate-600">â˜”ï¸ å•Ÿç”¨å‚™æ¡ˆ (Plan B)</span>
                        </label>
                        <div id="section-planb" class="hidden bg-orange-50 p-3 rounded-xl border border-orange-100 space-y-2">
                            <input type="text" id="itin-planb-title" placeholder="å‚™æ¡ˆæ¨™é¡Œ (ä¾‹: åšå¤šé‹æ²³åŸ)" class="w-full p-2 bg-white border border-orange-200 rounded-lg text-sm font-bold">
                            <textarea id="itin-planb-note" rows="2" placeholder="å‚™æ¡ˆèªªæ˜..." class="w-full p-2 bg-white border border-orange-200 rounded-lg text-sm"></textarea>
                        </div>
                    </div>

                    <textarea id="itin-note" rows="3" placeholder="ä¸€èˆ¬å‚™è¨»..." class="w-full p-3 bg-white/50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm"></textarea>

                    <!-- Buttons -->
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="deleteItinerary()" id="btn-del-itin" class="hidden w-12 flex items-center justify-center bg-red-100 text-red-500 rounded-xl hover:bg-red-200 transition"><i class="fas fa-trash"></i></button>
                        <button type="button" onclick="saveItinerary()" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">å„²å­˜è¡Œç¨‹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="modal-expense" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal('modal-expense')"></div>
        <div class="absolute bottom-0 inset-x-0 glass-panel rounded-t-[2rem] transform transition-transform duration-300 translate-y-full" id="sheet-expense">
            <div class="p-6 pb-safe-bottom">
                <div class="w-12 h-1.5 bg-slate-300/50 rounded-full mx-auto mb-6"></div>
                <h3 class="text-xl font-bold text-slate-800 mb-4">è¨˜ä¸€ç­†</h3>
                <form class="space-y-4">
                    <div class="flex gap-3">
                        <select id="exp-day" class="flex-1 p-3 bg-white/50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none"></select>
                        <select id="exp-payer" class="flex-1 p-3 bg-white/50 border border-slate-200 rounded-xl outline-none"></select>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-slate-400 font-bold">Â¥</span>
                        <input type="number" id="exp-amount" placeholder="0" class="w-full pl-8 p-3 bg-white/50 border border-slate-200 rounded-xl font-mono font-bold text-xl outline-none focus:ring-2 focus:ring-yellow-400">
                    </div>
                    <input type="text" id="exp-item" placeholder="é …ç›®åç¨±" class="w-full p-3 bg-white/50 border border-slate-200 rounded-xl outline-none">
                    <button type="button" onclick="saveExpense()" class="w-full py-3.5 bg-slate-800 text-white rounded-xl font-bold shadow-lg mt-2 active:scale-95 transition-transform">å„²å­˜</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-settings')"></div>
        <div class="relative glass-panel w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in">
            <h3 class="font-bold text-xl mb-4 text-slate-800">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500">èƒŒæ™¯åœ–ç‰‡ URL</label>
                    <input type="url" id="set-bg" placeholder="https://..." class="w-full p-2 bg-white/50 border border-slate-200 rounded-lg text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">æ—…ä¼´åå–®</label>
                    <input type="text" id="set-companions" class="w-full p-2 bg-white/50 border border-slate-200 rounded-lg">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">åŒ¯ç‡ (JPY â†’ TWD)</label>
                    <input type="number" step="0.001" id="set-rate" class="w-full p-2 bg-white/50 border border-slate-200 rounded-lg">
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-slate-200">
                    <button onclick="changeRoom()" class="text-xs text-blue-500 font-bold">æ›´æ› Room ID</button>
                    <button onclick="saveSettings()" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Todo Modal -->
    <div id="modal-todo" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal('modal-todo')"></div>
        <div class="absolute bottom-0 inset-x-0 glass-panel rounded-t-[2rem] transform transition-transform duration-300 translate-y-full" id="sheet-todo">
            <div class="p-6 pb-safe-bottom">
                <h3 class="text-lg font-bold mb-4">æ–°å¢å¾…è¾¦</h3>
                <input type="text" id="todo-input" placeholder="äº‹é …..." class="w-full p-3 bg-white/50 border border-slate-200 rounded-xl mb-4 outline-none">
                <button onclick="saveTodo()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyD5W4aG9X_DfyMVN9d1dWXkib8Ddk9qR1Y",
            authDomain: "fukuokagogogo.firebaseapp.com",
            projectId: "fukuokagogogo",
            storageBucket: "fukuokagogogo.firebasestorage.app",
            messagingSenderId: "751405629922",
            appId: "1:751405629922:web:a3ebcf616e94da7e41f9bb",
            measurementId: "G-SL7KHLJ9KS"
        };

        // State
        let db, docRef, roomId, appData;
        let currentTabId = 'todo';

        // NOTE: dates added for AI logic
        const CONFIG = {
            tabs: [
                { id: 'todo', label: 'å¾…è¾¦', type: 'todo' },
                { id: 'd1', label: '12/31', full: 'Day 1 (12/31)', type: 'day', date: '2024-12-31' },
                { id: 'd2', label: '1/1', full: 'Day 2 (1/1)', type: 'day', date: '2025-01-01' },
                { id: 'd3', label: '1/2', full: 'Day 3 (1/2)', type: 'day', date: '2025-01-02' },
                { id: 'd4', label: '1/3', full: 'Day 4 (1/3)', type: 'day', date: '2025-01-03' },
                { id: 'd5', label: '1/4', full: 'Day 5 (1/4)', type: 'day', date: '2025-01-04' },
                { id: 'd6', label: '1/5', full: 'Day 6 (1/5)', type: 'day', date: '2025-01-05' },
                { id: 'money', label: 'åˆ†å¸³', type: 'expense' }
            ],
            icons: {
                flight: { icon: 'fa-plane-departure', color: 'text-teal-600', bg: 'bg-teal-100' },
                transport: { icon: 'fa-train-subway', color: 'text-slate-600', bg: 'bg-slate-200' }, // Used inside connector, but def here
                food: { icon: 'fa-utensils', color: 'text-orange-500', bg: 'bg-orange-100' },
                spot: { icon: 'fa-camera', color: 'text-blue-500', bg: 'bg-blue-100' },
                shop: { icon: 'fa-shopping-bag', color: 'text-pink-500', bg: 'bg-pink-100' },
                hotel: { icon: 'fa-bed', color: 'text-purple-600', bg: 'bg-purple-100' }
            }
        };

        const defaultData = {
            checklist: [
                { id: 1, text: "é ç´„ Cinnamoroll Cafe", done: false },
                { id: 2, text: "é ç´„ç§Ÿè»Š (Day 3 å–è»Š)", done: false }
            ],
            itinerary: [
                { id: 101, day: 'd1', time: '10:00', category: 'flight', title: 'æŠµé”ç¦å²¡æ©Ÿå ´', flightNo: 'BR106', terminal: 'Intl', note: 'æ­åœ°éµè‡³åšå¤š' },
                { id: 102, day: 'd1', time: '14:00', category: 'spot', title: 'BOSS Eï½¥ZO', note: 'çµ•æ™¯ä¸‰å…„å¼Ÿ' },
                { id: 103, day: 'd1', time: '19:00', category: 'food', title: 'ä¸­æ´²å±‹å°', note: '' },
                { id: 201, day: 'd2', time: '09:00', category: 'transport', title: 'æ–°å¹¹ç·šç§»å‹•', stationFrom: 'åšå¤š', stationTo: 'ç†Šæœ¬', cost: 5000 },
                { id: 202, day: 'd2', time: '10:30', category: 'spot', title: 'ç†Šæœ¬åŸ', note: 'åŠ è—¤ç¥ç¤¾åˆè©£' },
            ],
            expenses: [],
            settings: { 
                companions: ["æˆ‘", "æ—…ä¼´A"], 
                rate: 0.22,
                bgUrl: "https://images.unsplash.com/photo-1570783852028-251f28b49749?q=80&w=2000&auto=format&fit=crop"
            }
        };

        // Init
        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                roomId = localStorage.getItem('fuku_room');
                if (!roomId) {
                    roomId = prompt("è«‹è¼¸å…¥æ—…éŠä»£è™Ÿ (Room ID):");
                    if (!roomId) roomId = 'demo';
                    localStorage.setItem('fuku_room', roomId);
                }
                document.getElementById('room-display').innerText = roomId;

                docRef = doc(db, "trips", roomId);
                onSnapshot(docRef, (snap) => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    if (snap.exists()) {
                        appData = snap.data();
                        updateBackground();
                        render();
                    } else {
                        appData = defaultData; // Fix: Ensure appData is set locally for new rooms
                        setDoc(docRef, defaultData);
                        updateBackground();
                        render();
                    }
                }, err => alert(err.message));

                renderTabs();
                renderWeather();
                window.switchTab('todo');
                
                // Start AI loop
                setInterval(checkAISuggestions, 60000);

            } catch (e) { console.error(e); }
        }

        async function sync() {
            if (docRef && appData) await updateDoc(docRef, appData);
        }

        // --- Renderers ---

        function render() {
            if (!appData) return; // Fix: Prevent rendering before data is loaded
            const container = document.getElementById('main-content');
            const tab = CONFIG.tabs.find(t => t.id === currentTabId);
            container.innerHTML = `<div class="h-1"></div>`;
            
            if (tab.type === 'todo') {
                renderAISuggestions(container); // Inject AI block
                renderTodo(container);
            }
            else if (tab.type === 'expense') renderExpense(container);
            else renderItinerary(container, tab);
        }

        // AI Feature
        function checkAISuggestions() {
            if (currentTabId === 'todo') render(); // Re-render to update AI block
        }

        function renderAISuggestions(c) {
            if (!appData?.itinerary) return;

            const now = new Date();
            // For demo: you can uncomment below to fake time
            // const now = new Date('2024-12-31T09:00:00'); 

            let alertHtml = '';
            
            // Look ahead in all days
            appData.itinerary.forEach(item => {
                const tabConfig = CONFIG.tabs.find(t => t.id === item.day);
                if (!tabConfig || !tabConfig.date) return;

                const itemDate = new Date(`${tabConfig.date}T${item.time}`);
                const diffMs = itemDate - now;
                const diffHrs = diffMs / (1000 * 60 * 60);

                // Logic Rules
                if (diffHrs > 0 && diffHrs < 3 && item.category === 'flight') {
                    alertHtml = `
                        <div class="mb-4 bg-teal-50 border border-teal-200 p-4 rounded-xl ai-alert shadow-sm flex gap-3 items-start">
                            <div class="text-2xl">ğŸ¤–</div>
                            <div>
                                <h4 class="font-bold text-teal-800 text-sm">å³å°‡ç™»æ©Ÿæé†’</h4>
                                <p class="text-xs text-teal-600 mt-1">é‚„æœ‰ ${Math.ceil(diffHrs*60)} åˆ†é˜ã€‚è«‹ç¢ºèªè­·ç…§èˆ‡å‰å¾€ <b>${item.terminal || 'èˆªå»ˆ'}</b>ã€‚</p>
                                <div class="mt-2 bg-white inline-block px-2 py-1 rounded border border-teal-100 font-mono text-xs font-bold">${item.flightNo || 'Flight'}</div>
                            </div>
                        </div>`;
                }
                else if (diffHrs > 0 && diffHrs < 2 && item.category === 'hotel') {
                    alertHtml = `
                        <div class="mb-4 bg-purple-50 border border-purple-200 p-4 rounded-xl ai-alert shadow-sm flex gap-3 items-start">
                            <div class="text-2xl">ğŸ¤–</div>
                            <div>
                                <h4 class="font-bold text-purple-800 text-sm">å³å°‡å…¥ä½é£¯åº—</h4>
                                <p class="text-xs text-purple-600 mt-1">è«‹æº–å‚™å¥½ Booking ID ä»¥ä¾›æŸ¥é©—ã€‚</p>
                                <div class="mt-2 font-mono text-lg font-bold text-purple-700 select-all">${item.bookingId || 'No ID'}</div>
                            </div>
                        </div>`;
                }
                else if (diffHrs > 0 && diffHrs < 1 && item.category === 'transport') {
                    alertHtml = `
                        <div class="mb-4 bg-slate-100 border border-slate-300 p-4 rounded-xl shadow-sm flex gap-3 items-start">
                            <div class="text-2xl">ğŸ¤–</div>
                            <div>
                                <h4 class="font-bold text-slate-700 text-sm">è¡Œç¨‹æé†’</h4>
                                <p class="text-xs text-slate-600 mt-1">æº–å‚™å‰å¾€ <b>${item.title}</b> (${item.stationFrom || 'å‡ºç™¼åœ°'} â†’ ${item.stationTo || 'ç›®çš„åœ°'})ã€‚</p>
                            </div>
                        </div>`;
                }
            });

            if (alertHtml) c.innerHTML += alertHtml;
        }

        function renderTodo(c) {
            const list = document.createElement('div');
            list.className = 'space-y-2';
            (appData?.checklist||[]).forEach(item => {
                const row = document.createElement('div');
                row.className = 'glass-card p-4 rounded-xl flex items-center gap-3 animate-fade-in';
                row.innerHTML = `
                    <input type="checkbox" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-0 check-anim" ${item.done ? 'checked' : ''}>
                    <div class="flex-1 font-bold text-slate-700 ${item.done ? 'line-through text-slate-400' : ''}">${item.text}</div>
                    <button class="del-btn text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                `;
                row.querySelector('input').onchange = () => { item.done = !item.done; sync(); };
                row.querySelector('.del-btn').onclick = () => { appData.checklist = appData.checklist.filter(i => i.id !== item.id); sync(); };
                list.appendChild(row);
            });
            c.appendChild(list);
        }

        function renderItinerary(c, tab) {
            const items = (appData.itinerary || []).filter(i => i.day === tab.id).sort((a,b) => a.time.localeCompare(b.time));
            
            const header = document.createElement('div');
            header.className = 'sticky top-0 z-10 py-2 mb-2 flex justify-center';
            header.innerHTML = `<span class="glass-panel px-3 py-1 rounded-full text-xs font-bold text-slate-600 shadow-sm">${tab.full}</span>`;
            c.appendChild(header);

            if (items.length === 0) {
                c.innerHTML += `<div class="text-center text-white/60 mt-10">å°šç„¡è¡Œç¨‹</div>`;
                return;
            }

            items.forEach((item, index) => {
                // SPECIAL RENDER FOR TRANSPORT (CONNECTOR STYLE)
                if (item.category === 'transport') {
                    const el = document.createElement('div');
                    el.className = 'connector-line flex items-center gap-3 py-3 px-4 mx-1 rounded-lg mb-3 animate-fade-in cursor-pointer hover:bg-slate-200/50 transition';
                    el.onclick = () => window.openItineraryModal(item.id);
                    el.innerHTML = `
                        <div class="flex flex-col items-center w-12 flex-none">
                            <span class="text-xs font-mono font-bold text-slate-500">${item.time}</span>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs flex-none z-10 border border-white">
                            <i class="fas fa-train"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 text-sm font-bold text-slate-700 truncate">
                                <span>${item.stationFrom || item.title || 'å‡ºç™¼'}</span>
                                <i class="fas fa-arrow-right text-xs text-slate-400"></i>
                                <span>${item.stationTo || 'åˆ°é”'}</span>
                            </div>
                            <div class="text-[10px] text-slate-500 truncate">${item.title !== item.stationFrom ? item.title : 'ç§»å‹•ä¸­'}</div>
                        </div>
                        ${item.cost ? `<div class="text-xs font-mono font-bold text-slate-500 bg-white px-1.5 py-0.5 rounded border border-slate-200">Â¥${item.cost}</div>` : ''}
                        ${item.url ? `<button onclick="event.stopPropagation(); window.open('${item.url}', '_blank')" class="ml-2 w-8 h-8 flex-none rounded-full bg-white text-blue-500 border border-slate-200 shadow-sm flex items-center justify-center z-20 active:scale-90 transition-transform"><i class="fas fa-location-arrow"></i></button>` : ''}
                    `;
                    c.appendChild(el);
                    return;
                }

                // STANDARD CARD RENDER
                const style = CONFIG.icons[item.category] || CONFIG.icons.spot;
                const card = document.createElement('div');
                card.className = 'glass-card p-4 rounded-2xl mb-3 relative animate-fade-in active:scale-[0.99] transition-transform z-10';
                card.onclick = (e) => { if (!e.target.closest('button') && !e.target.closest('a')) window.openItineraryModal(item.id); };

                let details = '';
                if (item.category === 'hotel' && item.checkInTime) details += `<span class="mr-2">ğŸ•’ CI: ${item.checkInTime}</span>`;
                if (item.category === 'hotel' && item.bookingId) details += `<span>ğŸ†”: ${item.bookingId}</span>`;
                if (item.category === 'flight' && item.flightNo) details += `<span class="mr-2">âœˆï¸ ${item.flightNo}</span>`;
                if (item.category === 'flight' && item.terminal) details += `<span>ğŸšª ${item.terminal}</span>`;
                
                let mapCodeBtn = '';
                if (item.mapCode) {
                    mapCodeBtn = `
                    <div class="mt-2 flex items-center gap-2 bg-slate-100/50 p-2 rounded-lg">
                        <span class="text-[10px] font-bold text-slate-500 bg-white px-1 rounded border">MC</span>
                        <span class="font-mono font-bold text-sm text-slate-700 flex-1">${item.mapCode}</span>
                        <button onclick="window.open('https://www.google.com/search?q=${item.title}+MapCode', '_blank')" class="w-8 h-8 flex items-center justify-center bg-blue-500 text-white rounded-lg shadow-sm"><i class="fas fa-search"></i></button>
                    </div>`;
                }

                let planBSection = '';
                if (item.planB) {
                    planBSection = `
                    <div class="mt-3 bg-blue-50/80 border border-blue-100 p-3 rounded-xl">
                        <div class="flex items-center gap-1 text-xs font-bold text-blue-600 mb-1"><i class="fas fa-umbrella"></i> Plan B</div>
                        <div class="font-bold text-sm text-slate-700">${item.planBTitle || 'ç„¡æ¨™é¡Œ'}</div>
                        <div class="text-xs text-slate-500">${item.planBNote || ''}</div>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center pt-1 w-12">
                            <span class="text-sm font-bold font-mono text-slate-600">${item.time}</span>
                            <div class="mt-2 w-10 h-10 rounded-2xl ${style.bg} ${style.color} flex items-center justify-center text-lg shadow-inner">
                                <i class="fas ${style.icon}"></i>
                            </div>
                            ${item.url ? `<button onclick="window.open('${item.url}', '_blank')" class="mt-2 w-8 h-8 rounded-full bg-white text-blue-500 shadow flex items-center justify-center"><i class="fas fa-location-arrow text-xs"></i></button>` : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-800 text-lg leading-tight truncate">${item.title}</h3>
                            ${details ? `<div class="text-xs font-mono text-slate-500 mt-1">${details}</div>` : ''}
                            ${item.note ? `<p class="text-sm text-slate-600 mt-1 line-clamp-2">${item.note}</p>` : ''}
                            ${mapCodeBtn}
                            ${planBSection}
                        </div>
                    </div>
                `;
                c.appendChild(card);
            });
        }

        function renderExpense(c) {
            let total = 0;
            const bal = {};
            (appData.settings.companions||[]).forEach(p => bal[p] = 0);
            (appData.expenses||[]).forEach(e => {
                total += e.amount;
                const twd = Math.round(e.amount * appData.settings.rate);
                bal[e.payer] += twd;
                const share = twd / appData.settings.companions.length;
                appData.settings.companions.forEach(p => bal[p] -= share);
            });

            let settlements = [], d = [], cr = [];
            for (const [p, v] of Object.entries(bal)) {
                if (v < -1) d.push({p, v});
                if (v > 1) cr.push({p, v});
            }
            d.sort((a,b)=>a.v-b.v); cr.sort((a,b)=>b.v-a.v);
            let i=0, j=0;
            while(i<d.length && j<cr.length) {
                const amt = Math.min(Math.abs(d[i].v), cr[j].v);
                settlements.push(`${d[i].p} â ${cr[j].p} $${Math.round(amt)}`);
                d[i].v += amt; cr[j].v -= amt;
                if(Math.abs(d[i].v)<1) i++; if(cr[j].v<1) j++;
            }

            const card = document.createElement('div');
            card.className = 'glass-card p-5 rounded-2xl mb-4 text-slate-800';
            card.innerHTML = `
                <div class="flex justify-between items-end mb-4">
                    <div><p class="text-[10px] uppercase font-bold text-slate-500">Total (TWD)</p><h2 class="text-3xl font-mono font-bold">NT$ ${Math.round(total * appData.settings.rate).toLocaleString()}</h2></div>
                    <div class="text-right"><p class="text-[10px] text-slate-500">Rate</p><p class="font-mono font-bold">${appData.settings.rate}</p></div>
                </div>
                <div class="pt-3 border-t border-slate-200/50 space-y-1">
                    ${settlements.length ? settlements.map(s => `<div class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded inline-block mr-1">${s}</div>`).join('') : '<span class="text-xs text-slate-400">All settled</span>'}
                </div>`;
            c.appendChild(card);

            const list = document.createElement('div');
            list.className = 'space-y-2';
            (appData.expenses||[]).slice().reverse().forEach(e => {
                const row = document.createElement('div');
                row.className = 'glass-card p-3 rounded-xl flex justify-between items-center';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-xs">${e.payer[0]}</div>
                        <div><div class="text-sm font-bold text-slate-800">${e.item}</div><div class="text-xs text-slate-500">Â¥${e.amount}</div></div>
                    </div>
                    <div class="text-sm font-mono font-bold text-slate-600">NT$${Math.round(e.amount * appData.settings.rate)}</div>
                `;
                row.onclick = () => { if(confirm('Delete?')) { appData.expenses = appData.expenses.filter(x => x.id !== e.id); sync(); }};
                list.appendChild(row);
            });
            c.appendChild(list);
        }

        // Tabs
        function renderTabs() {
            const el = document.getElementById('tabs-container');
            el.innerHTML = CONFIG.tabs.map(t => `
                <button onclick="window.switchTab('${t.id}')" 
                    class="flex-none px-4 py-1.5 rounded-full text-sm font-bold transition-all backdrop-blur-md border ${currentTabId===t.id ? (t.id==='money'?'bg-yellow-400 text-yellow-900 border-yellow-400':'bg-white text-blue-600 border-white') : 'bg-white/20 text-white border-transparent hover:bg-white/30'}">
                    ${t.label}
                </button>
            `).join('');
        }

        window.switchTab = (id) => {
            currentTabId = id;
            renderTabs();
            render();
            const fab = document.getElementById('fab-btn');
            if (id === 'money') { fab.classList.replace('bg-blue-600/90', 'bg-slate-800/90'); }
            else { fab.classList.replace('bg-slate-800/90', 'bg-blue-600/90'); }
        };

        // Weather
        async function renderWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5904&longitude=130.4017&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo&forecast_days=2');
                const data = await res.json();
                const now = new Date();
                const currentHour = now.getHours();
                const container = document.getElementById('weather-scroll');
                container.innerHTML = '';
                document.getElementById('weather-widget').classList.remove('hidden');
                document.getElementById('weather-updated').innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

                for (let i = 0; i < 24; i++) {
                    const idx = data.hourly.time.findIndex(t => new Date(t).getHours() === currentHour) + i;
                    if (idx >= data.hourly.time.length) break;
                    const temp = Math.round(data.hourly.temperature_2m[idx]);
                    const code = data.hourly.weathercode[idx];
                    const time = new Date(data.hourly.time[idx]).getHours();
                    let icon = 'fa-sun text-orange-400';
                    if (code > 3) icon = 'fa-cloud text-slate-400';
                    if (code > 50) icon = 'fa-umbrella text-blue-400';

                    container.innerHTML += `
                        <div class="flex flex-col items-center min-w-[3rem] ${i===0?'font-bold':''}">
                            <span class="text-[10px] text-slate-500">${i===0 ? 'Now' : time}</span>
                            <i class="fas ${icon} text-lg my-1"></i>
                            <span class="text-sm font-bold text-slate-700">${temp}Â°</span>
                        </div>
                    `;
                }
            } catch (e) { console.error("Weather failed", e); }
        }

        // Modal Logic
        window.openItineraryModal = (id = null) => {
            const item = id ? appData.itinerary.find(i => i.id === id) : null;
            document.getElementById('itin-modal-title').innerText = id ? 'ç·¨è¼¯' : 'æ–°å¢';
            document.getElementById('itin-badge').innerText = CONFIG.tabs.find(t=>t.id===currentTabId).full;
            
            // Fill Fields
            document.getElementById('itin-id').value = id || '';
            document.getElementById('itin-time').value = item?.time || '10:00';
            document.getElementById('itin-category').value = item?.category || 'spot';
            document.getElementById('itin-title').value = item?.title || '';
            document.getElementById('itin-mapcode').value = item?.mapCode || '';
            document.getElementById('itin-url').value = item?.url || '';
            document.getElementById('itin-note').value = item?.note || '';
            
            // Flight
            document.getElementById('itin-flight').value = item?.flightNo || '';
            document.getElementById('itin-terminal').value = item?.terminal || '';
            
            // Transport
            document.getElementById('itin-from').value = item?.stationFrom || '';
            document.getElementById('itin-to').value = item?.stationTo || '';
            document.getElementById('itin-cost').value = item?.cost || '';

            // Hotel
            document.getElementById('itin-checkin').value = item?.checkInTime || '';
            document.getElementById('itin-booking').value = item?.bookingId || '';

            // Plan B
            document.getElementById('itin-hasPlanB').checked = !!item?.planB;
            document.getElementById('itin-planb-title').value = item?.planBTitle || '';
            document.getElementById('itin-planb-note').value = item?.planBNote || '';
            
            window.toggleCategoryFields();
            window.togglePlanB();

            document.getElementById('btn-del-itin').style.display = id ? 'flex' : 'none';
            openModal('modal-itinerary');
        };

        window.toggleCategoryFields = () => {
            const cat = document.getElementById('itin-category').value;
            
            // Reset all
            document.getElementById('field-hotel').classList.add('hidden');
            document.getElementById('field-flight').classList.add('hidden');
            document.getElementById('field-transport').classList.add('hidden');
            document.getElementById('field-map').classList.remove('hidden');
            document.getElementById('lbl-title').innerText = "æ¨™é¡Œ / åç¨±";

            if (cat === 'hotel') {
                document.getElementById('field-hotel').classList.remove('hidden');
            } else if (cat === 'flight') {
                document.getElementById('field-flight').classList.remove('hidden');
                document.getElementById('field-map').classList.add('hidden'); // Flight rarely needs map code
            } else if (cat === 'transport') {
                document.getElementById('field-transport').classList.remove('hidden');
                document.getElementById('field-map').classList.add('hidden'); // MapCode hidden for transport, but global URL input remains visible
                document.getElementById('lbl-title').innerText = "èªªæ˜ (é¸å¡«)";
            }
        };

        window.togglePlanB = () => {
            const on = document.getElementById('itin-hasPlanB').checked;
            document.getElementById('section-planb').classList.toggle('hidden', !on);
        };

        window.searchMapCode = () => {
            const title = document.getElementById('itin-title').value;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(title + ' MapCode')}`, '_blank');
        };

        window.saveItinerary = () => {
            const id = document.getElementById('itin-id').value;
            const category = document.getElementById('itin-category').value;
            let title = document.getElementById('itin-title').value;
            
            // For transport, if title is empty, generate from stations
            if (category === 'transport' && !title) {
                const from = document.getElementById('itin-from').value;
                const to = document.getElementById('itin-to').value;
                if (from && to) title = `${from} â†’ ${to}`;
                else title = 'äº¤é€šç§»å‹•';
            }

            if (!title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');

            const newItem = {
                id: id ? parseInt(id) : Date.now(),
                day: currentTabId,
                time: document.getElementById('itin-time').value,
                category,
                title,
                mapCode: document.getElementById('itin-mapcode').value,
                url: document.getElementById('itin-url').value,
                note: document.getElementById('itin-note').value,
                // Fields
                checkInTime: document.getElementById('itin-checkin').value,
                bookingId: document.getElementById('itin-booking').value,
                flightNo: document.getElementById('itin-flight').value,
                terminal: document.getElementById('itin-terminal').value,
                stationFrom: document.getElementById('itin-from').value,
                stationTo: document.getElementById('itin-to').value,
                cost: document.getElementById('itin-cost').value,
                // Plan B
                planB: document.getElementById('itin-hasPlanB').checked,
                planBTitle: document.getElementById('itin-planb-title').value,
                planBNote: document.getElementById('itin-planb-note').value
            };

            if (id) {
                const idx = appData.itinerary.findIndex(i => i.id == id);
                if (idx > -1) appData.itinerary[idx] = newItem;
            } else {
                appData.itinerary.push(newItem);
            }
            sync();
            closeModal('modal-itinerary');
        };

        // Settings
        window.openSettings = () => {
            document.getElementById('set-bg').value = appData.settings.bgUrl || '';
            document.getElementById('set-companions').value = appData.settings.companions.join(',');
            document.getElementById('set-rate').value = appData.settings.rate;
            openModal('modal-settings');
        };
        
        window.saveSettings = () => {
            appData.settings.bgUrl = document.getElementById('set-bg').value;
            appData.settings.companions = document.getElementById('set-companions').value.split(',');
            appData.settings.rate = parseFloat(document.getElementById('set-rate').value);
            sync();
            updateBackground();
            closeModal('modal-settings');
        };

        function updateBackground() {
            if(appData?.settings?.bgUrl) {
                document.getElementById('app-bg').style.backgroundImage = `url('${appData.settings.bgUrl}')`;
            }
        }

        // Utils
        window.changeRoom = () => { localStorage.removeItem('fuku_room'); location.reload(); };
        window.deleteItinerary = () => { 
            const id = parseInt(document.getElementById('itin-id').value);
            if(confirm('Delete?')) { appData.itinerary = appData.itinerary.filter(i=>i.id!==id); sync(); closeModal('modal-itinerary'); } 
        };
        window.handleFab = () => {
            if(currentTabId==='todo') openModal('modal-todo');
            else if(currentTabId==='money') {
                document.getElementById('exp-day').innerHTML = CONFIG.tabs.filter(t=>t.type==='day').map(d=>`<option value="${d.id}">${d.full}</option>`).join('');
                document.getElementById('exp-payer').innerHTML = appData.settings.companions.map(p=>`<option value="${p}">${p}</option>`).join('');
                openModal('modal-expense');
            }
            else window.openItineraryModal();
        };
        window.saveTodo = () => { const v = document.getElementById('todo-input').value; if(v) { appData.checklist.push({id:Date.now(), text:v, done:false}); sync(); document.getElementById('todo-input').value=''; closeModal('modal-todo'); }};
        window.saveExpense = () => {
             const amt = document.getElementById('exp-amount').value; const itm = document.getElementById('exp-item').value;
             if(amt && itm) { appData.expenses.push({id:Date.now(), dayId:document.getElementById('exp-day').value, payer:document.getElementById('exp-payer').value, amount:parseInt(amt), item:itm}); sync(); closeModal('modal-expense'); }
        };

        // Common Modal
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            setTimeout(() => {
                const sheet = document.getElementById(id).querySelector('div[id^="sheet-"], .glass-panel');
                if(sheet.id.includes('sheet')) sheet.classList.remove('translate-y-full');
            }, 10);
        };
        window.closeModal = (id) => {
            const m = document.getElementById(id);
            const s = m.querySelector('div[id^="sheet-"]');
            if(s) s.classList.add('translate-y-full');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        init();
    </script>
</body>
</html>
