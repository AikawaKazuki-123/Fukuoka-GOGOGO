<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¦å²¡æ—…äºº (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/torii.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        /* iOS Safe Area é©é… */
        .pt-safe-top { padding-top: max(12px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .check-anim:checked + div {
            text-decoration: line-through;
            color: #94a3b8;
        }

        /* è¼‰å…¥ä¸­é®ç½© */
        #loading-overlay {
            position: fixed; inset: 0; background: #f8fafc; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loading-overlay">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-slate-500 font-bold animate-pulse">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <!-- 1. Header -->
    <header class="glass-header z-30 pt-safe-top flex-none">
        <div class="px-4 py-2 flex justify-between items-center h-14">
            <div>
                <h1 class="text-lg font-bold text-slate-800 leading-tight">FUKUOKA <span class="text-blue-600">CLOUD</span></h1>
                <div class="text-[10px] text-slate-500 font-mono flex gap-2 items-center">
                    <button onclick="changeRoom()" class="bg-slate-100 px-1.5 rounded hover:bg-slate-200 transition-colors">
                        ID: <span id="room-display">...</span> <i class="fas fa-pen ml-1 text-[8px]"></i>
                    </button>
                    <span>|</span>
                    <span id="clock">--:--</span>
                    <span>|</span>
                    <span id="weather"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
            </div>
            <button onclick="openSettings()" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <!-- æ»‘å‹•åˆ†é åˆ— -->
        <div class="flex overflow-x-auto no-scrollbar px-2 pb-0 space-x-1" id="tabs-container">
            <!-- JS ç”Ÿæˆ -->
        </div>
    </header>

    <!-- 2. Main Content -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
        <!-- JS æ¸²æŸ“ -->
    </main>

    <!-- 3. FAB -->
    <button onclick="handleFab()" id="fab-btn" class="fixed bottom-8 right-6 w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-500/40 flex items-center justify-center text-2xl z-40 active:scale-95 transition-transform pb-safe-bottom">
        <i class="fas fa-plus"></i>
    </button>

    <!-- ================= MODALS ================= -->

    <!-- Modal: æ–°å¢/ç·¨è¼¯è¡Œç¨‹ -->
    <div id="modal-itinerary" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeModal('modal-itinerary')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe-bottom" id="sheet-itinerary">
            <div class="p-6">
                <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span id="itin-modal-title">è¡Œç¨‹</span>
                    <span id="itin-badge" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500"></span>
                </h3>
                
                <form id="form-itinerary" class="space-y-4">
                    <input type="hidden" id="itin-id">
                    <div class="flex gap-3">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-slate-400 mb-1">æ™‚é–“</label>
                            <input type="time" id="itin-time" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none font-mono">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">åˆ†é¡</label>
                            <select id="itin-category" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none">
                                <option value="spot">ğŸ“¸ æ™¯é»</option>
                                <option value="food">ğŸœ ç¾é£Ÿ</option>
                                <option value="transport">ğŸš† äº¤é€š</option>
                                <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="hotel">ğŸ¨ ä½å®¿</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" id="itin-title" placeholder="æ¨™é¡Œ" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none font-bold">
                    <input type="url" id="itin-url" placeholder="Google Maps é€£çµ (é¸å¡«)" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none text-sm">
                    <textarea id="itin-note" rows="2" placeholder="å‚™è¨»..." class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none text-sm"></textarea>
                    
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="deleteItinerary()" id="btn-del-itin" class="hidden px-4 bg-red-50 text-red-500 rounded-xl font-bold"><i class="fas fa-trash"></i></button>
                        <button type="button" onclick="saveItinerary()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30">å„²å­˜è®Šæ›´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: è¨˜å¸³ -->
    <div id="modal-expense" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeModal('modal-expense')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe-bottom" id="sheet-expense">
            <div class="p-6">
                <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4">è¨˜å¸³</h3>
                <form class="space-y-4">
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">æ—¥æœŸ</label>
                            <select id="exp-day" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 font-bold text-slate-700"></select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">ä»˜æ¬¾äºº</label>
                            <select id="exp-payer" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">é‡‘é¡ (JPY)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-slate-400 font-bold">Â¥</span>
                            <input type="number" id="exp-amount" placeholder="0" class="w-full pl-8 p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-yellow-500 outline-none font-mono font-bold text-xl">
                        </div>
                    </div>
                    <input type="text" id="exp-item" placeholder="é …ç›®åç¨±" class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 outline-none">
                    <button type="button" onclick="saveExpense()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg mt-2">å„²å­˜</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: å¾…è¾¦ -->
    <div id="modal-todo" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeModal('modal-todo')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe-bottom" id="sheet-todo">
            <div class="p-6">
                <h3 class="text-lg font-bold mb-4">æ–°å¢å¾…è¾¦</h3>
                <input type="text" id="todo-input" placeholder="ä¾‹å¦‚ï¼šé ç´„é¤å»³..." class="w-full p-3 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 mb-4 outline-none">
                <button onclick="saveTodo()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Modal: è¨­å®š -->
    <div id="modal-settings" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ—…ä¼´åå–® (é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="set-companions" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">åŒ¯ç‡ (JPY â†’ TWD)</label>
                    <input type="number" step="0.001" id="set-rate" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-slate-100">
                    <button onclick="changeRoom()" class="text-xs text-blue-500 underline">åˆ‡æ›æ—…éŠä»£è™Ÿ</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold text-sm">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Logic (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5W4aG9X_DfyMVN9d1dWXkib8Ddk9qR1Y",
            authDomain: "fukuokagogogo.firebaseapp.com",
            projectId: "fukuokagogogo",
            storageBucket: "fukuokagogogo.firebasestorage.app",
            messagingSenderId: "751405629922",
            appId: "1:751405629922:web:a3ebcf616e94da7e41f9bb",
            measurementId: "G-SL7KHLJ9KS"
        };

        // --- App Global State ---
        let db, docRef, roomId;
        let appData = null;
        let currentTabId = 'todo';

        const CONFIG = {
            tabs: [
                { id: 'todo', label: 'ğŸ“‹ å¾…è¾¦', type: 'todo' },
                { id: 'd1', label: '12/31', full: '12/31 (Day 1)', type: 'day' },
                { id: 'd2', label: '1/1', full: '1/1 (Day 2)', type: 'day' },
                { id: 'd3', label: '1/2', full: '1/2 (Day 3)', type: 'day' },
                { id: 'd4', label: '1/3', full: '1/3 (Day 4)', type: 'day' },
                { id: 'd5', label: '1/4', full: '1/4 (Day 5)', type: 'day' },
                { id: 'd6', label: '1/5', full: '1/5 (Day 6)', type: 'day' },
                { id: 'money', label: 'ğŸ’° åˆ†å¸³', type: 'expense' }
            ],
            icons: {
                transport: { icon: 'fa-train', color: 'text-blue-500', bg: 'bg-blue-100' },
                food: { icon: 'fa-utensils', color: 'text-orange-500', bg: 'bg-orange-100' },
                spot: { icon: 'fa-camera', color: 'text-green-500', bg: 'bg-green-100' },
                shop: { icon: 'fa-shopping-bag', color: 'text-pink-500', bg: 'bg-pink-100' },
                hotel: { icon: 'fa-bed', color: 'text-purple-500', bg: 'bg-purple-100' }
            }
        };

        const defaultData = {
            checklist: [
                { id: 1, text: "é ç´„ Cinnamoroll Cafe", done: false },
                { id: 2, text: "é ç´„ç§Ÿè»Š (1/2 å–è»Š)", done: false },
                { id: 3, text: "è³¼è²· JR Pass", done: false }
            ],
            itinerary: [
                { id: 101, day: 'd1', time: '10:00', category: 'transport', title: 'æŠµé”ç¦å²¡æ©Ÿå ´', note: 'æ­åœ°éµè‡³åšå¤š', url: '' },
                { id: 102, day: 'd1', time: '12:00', category: 'food', title: 'åšå¤šè»Šç«™åˆé¤', note: 'AMU Plaza', url: '' },
                { id: 103, day: 'd1', time: '14:00', category: 'spot', title: 'BOSS Eï½¥ZO FUKUOKA', note: 'çµ•æ™¯ä¸‰å…„å¼Ÿ', url: '' },
                { id: 104, day: 'd1', time: '17:00', category: 'spot', title: 'ç¦å²¡å¡”', note: 'å¤•é™½å¤œæ™¯', url: '' },
                { id: 105, day: 'd1', time: '19:00', category: 'food', title: 'ä¸­æ´²å±‹å°è¡—', note: 'é«”é©—æ°£æ°›', url: '' },

                { id: 201, day: 'd2', time: '09:00', category: 'transport', title: 'æ­æ–°å¹¹ç·šå¾€ç†Šæœ¬', note: '', url: '' },
                { id: 202, day: 'd2', time: '10:00', category: 'spot', title: 'ç†Šæœ¬åŸ & åŠ è—¤ç¥ç¤¾', note: 'åˆè©£', url: '' },
                { id: 203, day: 'd2', time: '12:00', category: 'food', title: 'æ«»ä¹‹é¦¬å ´ åŸå½©è‹‘', note: 'åˆé¤', url: '' },
                { id: 204, day: 'd2', time: '14:00', category: 'transport', title: 'æ–°å¹¹ç·šå›åšå¤š', note: '', url: '' },
                { id: 205, day: 'd2', time: '16:00', category: 'spot', title: 'æ«›ç”°ç¥ç¤¾', note: 'é£¾å±±ç¬ ', url: '' },
                { id: 206, day: 'd2', time: '18:00', category: 'food', title: 'åšå¤šç‰›è…¸é‹', note: 'æ™šé¤', url: '' },

                { id: 301, day: 'd3', time: '09:00', category: 'transport', title: 'åšå¤šç§Ÿè»Š', note: 'å–è»Š', url: '' },
                { id: 302, day: 'd3', time: '10:30', category: 'spot', title: 'å°å€‰åŸ', note: '', url: '' },
                { id: 303, day: 'd3', time: '12:00', category: 'food', title: 'æ—¦éå¸‚å ´', note: 'åˆé¤', url: '' },
                { id: 304, day: 'd3', time: '14:00', category: 'spot', title: 'é–€å¸æ¸¯æ‡·èˆŠå€', note: '', url: '' },
                { id: 305, day: 'd3', time: '15:30', category: 'spot', title: 'å’Œå¸ƒåˆˆç¥ç¤¾', note: 'é—œé–€å¤§æ©‹', url: '' },
                { id: 306, day: 'd3', time: '18:00', category: 'food', title: 'ç„—çƒ¤å’–å“©', note: 'æ™šé¤', url: '' },

                { id: 401, day: 'd4', time: '07:30', category: 'transport', title: 'é–‹è»Šå¾€åˆ¥åºœ', note: '', url: '' },
                { id: 402, day: 'd4', time: '09:40', category: 'spot', title: 'ä¹å·è‡ªç„¶å‹•ç‰©åœ’', note: 'Jungle Bus', url: '' },
                { id: 403, day: 'd4', time: '14:00', category: 'spot', title: 'æ˜ç¤¬æº«æ³‰', note: 'æ¹¯ä¹‹é‡Œ', url: '' },
                { id: 404, day: 'd4', time: '15:30', category: 'food', title: 'å²¡æœ¬å±‹è³£åº—', note: 'åœ°ç„è’¸å¸ƒä¸', url: '' },
                { id: 405, day: 'd4', time: '17:00', category: 'transport', title: 'å›åšå¤šé‚„è»Š', note: '', url: '' },

                { id: 501, day: 'd5', time: '10:00', category: 'spot', title: 'æµ·ä¹‹ä¸­é“', note: 'å‹•ç‰©ä¹‹æ£®', url: '' },
                { id: 502, day: 'd5', time: '17:00', category: 'spot', title: 'åšå¤šé‹æ²³åŸ', note: 'å™´æ°´ç§€', url: '' },
                { id: 503, day: 'd5', time: '18:00', category: 'food', title: 'Cinnamoroll Cafe', note: 'é ç´„åˆ¶æ™šé¤', url: '' },

                { id: 601, day: 'd6', time: '10:00', category: 'shop', title: 'LaLaport ç¦å²¡', note: 'é‹¼å½ˆ', url: '' },
                { id: 602, day: 'd6', time: '14:00', category: 'transport', title: 'å‰å¾€ç¦å²¡æ©Ÿå ´', note: '', url: '' }
            ],
            expenses: [],
            settings: { companions: ["æˆ‘", "æ—…ä¼´A"], rate: 0.22 }
        };

        // --- Init & Firebase Logic ---
        async function initApp() {
            try {
                // 1. Init Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                // 2. Room Logic
                roomId = localStorage.getItem('fukuoka_room_id');
                if (!roomId) {
                    roomId = prompt("è«‹è¼¸å…¥æ—…éŠä»£è™Ÿ (Room ID)\nä¾‹å¦‚: Fukuoka2025");
                    if (!roomId) roomId = "demo"; 
                    localStorage.setItem('fukuoka_room_id', roomId);
                }
                document.getElementById('room-display').innerText = roomId;

                // 3. Connect Firestore
                docRef = doc(db, "trips", roomId);
                
                // Real-time listener
                onSnapshot(docRef, (docSnap) => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    if (docSnap.exists()) {
                        appData = docSnap.data();
                        renderContent(); // è³‡æ–™æ›´æ–°å³é‡ç¹ª
                    } else {
                        // First time: Write default data
                        setDoc(docRef, defaultData);
                    }
                }, (error) => {
                    alert("é€£ç·šéŒ¯èª¤: " + error.message);
                });

                renderTabs();
                switchTab('todo'); // Render initial tab structure
                startClock();
                fetchWeather();

            } catch (e) {
                console.error(e);
                alert("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        }

        // --- Core Functions ---
        async function syncData() {
            if (!docRef || !appData) return;
            try {
                await updateDoc(docRef, appData);
            } catch (e) {
                console.error("Sync failed", e);
            }
        }

        window.changeRoom = () => {
            localStorage.removeItem('fukuoka_room_id');
            location.reload();
        };

        // --- UI Rendering ---
        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = CONFIG.tabs.map(tab => `
                <button onclick="window.switchTab('${tab.id}')" 
                    class="tab-btn flex-none px-4 py-3 text-sm font-bold transition-all border-b-2 border-transparent outline-none text-slate-400" 
                    data-id="${tab.id}">
                    ${tab.label}
                </button>
            `).join('');
        }

        window.switchTab = (id) => {
            currentTabId = id;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.id === id;
                if(isActive) {
                    btn.className = `tab-btn flex-none px-4 py-3 text-sm font-bold transition-all border-b-2 outline-none ${id==='money'?'border-yellow-500 text-yellow-700 bg-yellow-50/50':'border-blue-600 text-blue-600 bg-blue-50/50'}`;
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.className = `tab-btn flex-none px-4 py-3 text-sm font-bold transition-all border-b-2 border-transparent text-slate-400 outline-none`;
                }
            });
            
            const fab = document.getElementById('fab-btn');
            if(id === 'money') fab.className = fab.className.replace('bg-blue-600', 'bg-slate-800').replace('shadow-blue-500/40', 'shadow-slate-500/40');
            else fab.className = fab.className.replace('bg-slate-800', 'bg-blue-600').replace('shadow-slate-500/40', 'shadow-blue-500/40');

            renderContent();
        };

        function renderContent() {
            if (!appData) return;
            const container = document.getElementById('main-content');
            const tab = CONFIG.tabs.find(t => t.id === currentTabId);
            container.innerHTML = `<div class="h-2"></div>`;

            if (tab.type === 'todo') renderTodo(container);
            else if (tab.type === 'expense') renderExpense(container);
            else renderItinerary(container, tab);
        }

        // --- Module: Todo ---
        function renderTodo(container) {
            const list = document.createElement('div');
            list.className = 'space-y-3';
            appData.checklist.forEach(item => {
                const row = document.createElement('label');
                row.className = 'flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 cursor-pointer active:scale-[0.99] transition-transform';
                row.innerHTML = `
                    <input type="checkbox" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 check-anim" 
                        ${item.done ? 'checked' : ''} onchange="window.toggleTodo(${item.id})">
                    <div class="ml-3 flex-1 text-slate-700 font-medium ${item.done ? 'line-through text-slate-400' : ''}">${item.text}</div>
                    <button onclick="window.deleteTodo(event, ${item.id})" class="text-slate-300 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(row);
            });
            container.appendChild(list);
        }

        window.toggleTodo = (id) => {
            const item = appData.checklist.find(i => i.id === id);
            if(item) { item.done = !item.done; syncData(); }
        };

        window.saveTodo = () => {
            const val = document.getElementById('todo-input').value;
            if(val) {
                appData.checklist.push({ id: Date.now(), text: val, done: false });
                syncData();
                document.getElementById('todo-input').value = '';
                closeModal('modal-todo');
            }
        };

        window.deleteTodo = (e, id) => {
            e.preventDefault();
            if(confirm('åˆªé™¤?')) {
                appData.checklist = appData.checklist.filter(i => i.id !== id);
                syncData();
            }
        };

        // --- Module: Itinerary ---
        function renderItinerary(container, tab) {
            const items = appData.itinerary.filter(i => i.day === tab.id).sort((a,b) => a.time.localeCompare(b.time));
            
            container.innerHTML += `
                <div class="sticky top-0 z-10 bg-[#f1f5f9]/95 backdrop-blur py-2 mb-2 flex items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-200 px-2 py-1 rounded">${tab.full}</span>
                    <div class="h-px bg-slate-200 flex-1 ml-3"></div>
                </div>`;

            if (items.length === 0) {
                container.innerHTML += `<div class="text-center text-slate-300 mt-10">ç„¡è¡Œç¨‹</div>`;
                return;
            }

            items.forEach(item => {
                const style = CONFIG.icons[item.category] || CONFIG.icons.spot;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl p-4 mb-3 shadow-sm border border-slate-100 flex gap-4 relative group active:scale-[0.98] transition-transform';
                card.onclick = (e) => { if(!e.target.closest('button')) window.openItineraryModal(item.id); };
                card.innerHTML = `
                    <div class="flex flex-col items-center pt-1 w-14 border-r border-slate-50 pr-2">
                        <span class="text-sm font-bold font-mono text-slate-600">${item.time}</span>
                        <div class="mt-2 w-8 h-8 rounded-full ${style.bg} ${style.color} flex items-center justify-center text-xs shadow-sm"><i class="fas ${style.icon}"></i></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight truncate">${item.title}</h3>
                        ${item.note ? `<p class="text-xs text-slate-400 mt-1 line-clamp-2">${item.note}</p>` : ''}
                        ${item.url ? `<button onclick="window.open('${item.url}', '_blank')" class="mt-2 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-bold flex items-center gap-1 hover:bg-blue-100"><i class="fas fa-location-arrow"></i> å°èˆª</button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.openItineraryModal = (id = null) => {
            const item = id ? appData.itinerary.find(i => i.id === id) : null;
            document.getElementById('itin-modal-title').innerText = id ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹';
            document.getElementById('itin-badge').innerText = CONFIG.tabs.find(t=>t.id===currentTabId).full;
            document.getElementById('itin-id').value = id || '';
            document.getElementById('itin-time').value = item ? item.time : '10:00';
            document.getElementById('itin-category').value = item ? item.category : 'spot';
            document.getElementById('itin-title').value = item ? item.title : '';
            document.getElementById('itin-url').value = item ? (item.url || '') : '';
            document.getElementById('itin-note').value = item ? (item.note || '') : '';
            
            const delBtn = document.getElementById('btn-del-itin');
            if(id) delBtn.classList.remove('hidden'); else delBtn.classList.add('hidden');
            
            document.getElementById('modal-itinerary').classList.remove('hidden');
            setTimeout(() => document.getElementById('sheet-itinerary').classList.remove('translate-y-full'), 10);
        };

        window.saveItinerary = () => {
            const id = document.getElementById('itin-id').value;
            const title = document.getElementById('itin-title').value;
            if(!title) return;
            
            const newItem = {
                id: id ? parseInt(id) : Date.now(),
                day: currentTabId,
                time: document.getElementById('itin-time').value,
                category: document.getElementById('itin-category').value,
                title,
                url: document.getElementById('itin-url').value,
                note: document.getElementById('itin-note').value
            };

            if(id) {
                const idx = appData.itinerary.findIndex(i => i.id == id);
                if(idx > -1) appData.itinerary[idx] = newItem;
            } else {
                appData.itinerary.push(newItem);
            }
            syncData();
            closeModal('modal-itinerary');
        };

        window.deleteItinerary = () => {
            const id = parseInt(document.getElementById('itin-id').value);
            if(confirm('ç¢ºå®šåˆªé™¤?')) {
                appData.itinerary = appData.itinerary.filter(i => i.id !== id);
                syncData();
                closeModal('modal-itinerary');
            }
        };

        // --- Module: Expense ---
        function renderExpense(container) {
            let totalJPY = 0;
            const balances = {};
            appData.settings.companions.forEach(p => balances[p] = 0);

            appData.expenses.forEach(e => {
                totalJPY += e.amount;
                const twd = Math.round(e.amount * appData.settings.rate);
                balances[e.payer] += twd;
                const share = twd / appData.settings.companions.length;
                appData.settings.companions.forEach(p => balances[p] -= share);
            });
            const totalTWD = Math.round(totalJPY * appData.settings.rate);

            // Settlement Logic
            let settlements = [], debtors = [], creditors = [];
            for(const [p, amt] of Object.entries(balances)) {
                if(amt < -1) debtors.push({p, amt});
                if(amt > 1) creditors.push({p, amt});
            }
            debtors.sort((a,b)=>a.amt - b.amt); creditors.sort((a,b)=>b.amt - a.amt);
            let i=0, j=0;
            while(i<debtors.length && j<creditors.length) {
                const val = Math.min(Math.abs(debtors[i].amt), creditors[j].amt);
                settlements.push(`${debtors[i].p} â†’ ${creditors[j].p} : $${Math.round(val)}`);
                debtors[i].amt += val; creditors[j].amt -= val;
                if(Math.abs(debtors[i].amt)<1) i++; if(creditors[j].amt<1) j++;
            }

            container.innerHTML += `
                <div class="bg-slate-800 text-white p-5 rounded-2xl shadow-lg mb-6">
                    <div class="flex justify-between items-end mb-4">
                        <div><p class="text-[10px] text-slate-400 uppercase">ç¸½æ”¯å‡º (TWD)</p><h2 class="text-3xl font-mono font-bold">NT$ ${totalTWD.toLocaleString()}</h2></div>
                        <div class="text-right"><p class="text-[10px] text-slate-400">åŒ¯ç‡</p><p class="font-mono font-bold">${appData.settings.rate}</p></div>
                    </div>
                    <div class="pt-3 border-t border-slate-700 space-y-1">${settlements.length ? settlements.map(s => `<div class="text-xs font-mono text-yellow-400">${s}</div>`).join('') : '<div class="text-xs text-slate-500">å·²çµæ¸…</div>'}</div>
                </div>`;

            [...appData.expenses].reverse().forEach(exp => {
                const dayLabel = CONFIG.tabs.find(t=>t.id===exp.dayId)?.label || '';
                const row = document.createElement('div');
                row.className = 'bg-white p-3 rounded-xl border border-slate-100 mb-2 flex justify-between items-center shadow-sm';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-center w-10"><span class="text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold">${dayLabel}</span><div class="mt-1 w-6 h-6 rounded-full bg-slate-800 text-white text-[10px] flex items-center justify-center">${exp.payer.charAt(0)}</div></div>
                        <div><div class="font-bold text-slate-800 text-sm">${exp.item}</div><div class="text-xs text-slate-400">Â¥${exp.amount.toLocaleString()}</div></div>
                    </div>
                    <div class="text-right font-mono font-bold text-slate-700 text-sm">NT$${Math.round(exp.amount*appData.settings.rate)}</div>`;
                row.onclick = () => { if(confirm(`åˆªé™¤ ${exp.item}?`)) { appData.expenses = appData.expenses.filter(x=>x.id!==exp.id); syncData(); } };
                container.appendChild(row);
            });
        }

        window.openExpenseModal = () => {
            const days = CONFIG.tabs.filter(t=>t.type==='day');
            document.getElementById('exp-day').innerHTML = days.map(d=>`<option value="${d.id}">${d.full}</option>`).join('');
            document.getElementById('exp-payer').innerHTML = appData.settings.companions.map(p=>`<option value="${p}">${p}</option>`).join('');
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-item').value = '';
            document.getElementById('modal-expense').classList.remove('hidden');
            setTimeout(() => document.getElementById('sheet-expense').classList.remove('translate-y-full'), 10);
        };

        window.saveExpense = () => {
            const amount = parseInt(document.getElementById('exp-amount').value);
            const item = document.getElementById('exp-item').value;
            if(!amount || !item) return;
            appData.expenses.push({ id: Date.now(), dayId: document.getElementById('exp-day').value, payer: document.getElementById('exp-payer').value, amount, item });
            syncData();
            closeModal('modal-expense');
        };

        // --- Settings & Utils ---
        window.openSettings = () => {
            document.getElementById('set-companions').value = appData.settings.companions.join(',');
            document.getElementById('set-rate').value = appData.settings.rate;
            document.getElementById('modal-settings').classList.remove('hidden');
        };

        window.saveSettings = () => {
            const comps = document.getElementById('set-companions').value.split(',').map(s=>s.trim()).filter(s=>s);
            if(comps.length) appData.settings.companions = comps;
            appData.settings.rate = parseFloat(document.getElementById('set-rate').value);
            syncData();
            closeModal('modal-settings');
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            const sheet = modal.querySelector('div[id^="sheet-"]');
            if(sheet) sheet.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        window.handleFab = () => {
            if(currentTabId === 'todo') { document.getElementById('modal-todo').classList.remove('hidden'); setTimeout(()=>document.getElementById('sheet-todo').classList.remove('translate-y-full'),10); }
            else if(currentTabId === 'money') window.openExpenseModal();
            else window.openItineraryModal();
        };

        // System
        function startClock() { setInterval(() => { const n = new Date(); document.getElementById('clock').innerText = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }, 1000); }
        async function fetchWeather() {
            try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5904&longitude=130.4017&current_weather=true&timezone=Asia%2FTokyo'); const d = await res.json(); document.getElementById('weather').innerHTML = `${Math.round(d.current_weather.temperature)}Â°C`; } catch {}
        }

        // Start App
        initApp();
    </script>
</body>
</html>
