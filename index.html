<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡æ—…äºº V3</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/torii.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™æ»‘å‹•åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ç»ç’ƒæ“¬æ…‹ header */
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid #e2e8f0;
        }

        /* åº•éƒ¨ FAB å‹•ç•« */
        .fab-btn { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fab-btn:active { transform: scale(0.9); }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 overflow-hidden">

    <!-- 1. Header (å›ºå®šé ‚éƒ¨) -->
    <header class="glass-header z-30 pt-safe-top flex-none">
        <!-- ä¸Šå±¤ï¼šæ¨™é¡Œèˆ‡è³‡è¨Š -->
        <div class="px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-blue-900 tracking-tight">FUKUOKA <span class="text-blue-500">TRIP</span></h1>
                <div class="text-xs text-slate-500 flex gap-2 font-mono mt-0.5">
                    <span id="clock">--:--</span>
                    <span>|</span>
                    <span id="weather">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition-colors">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <!-- ä¸‹å±¤ï¼šæ»‘å‹•åˆ†é åˆ— (Scrollable Tabs) -->
        <div class="flex overflow-x-auto no-scrollbar px-2 pb-0 space-x-2" id="tabs-container">
            <!-- JS å°‡å‹•æ…‹ç”Ÿæˆ Tabs -->
        </div>
    </header>

    <!-- 2. ä¸»è¦å…§å®¹å€ (å¯æ»¾å‹•) -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar bg-slate-50 relative p-4 pb-24">
        <!-- å…§å®¹ç”± JS å‹•æ…‹æ›¿æ› -->
    </main>

    <!-- 3. Floating Action Button (FAB) -->
    <button onclick="handleFabClick()" class="fab-btn fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-500/40 flex items-center justify-center text-2xl z-40">
        <i class="fas fa-plus"></i>
    </button>

    <!-- ================= MODALS ================= -->

    <!-- Modal: æ–°å¢/ç·¨è¼¯è¡Œç¨‹ -->
    <div id="modal-itinerary" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal('modal-itinerary')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full md:max-w-md md:left-1/2 md:-translate-x-1/2" id="sheet-itinerary">
            <div class="p-6">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span id="itin-modal-title">æ–°å¢è¡Œç¨‹</span>
                    <span id="itin-modal-day-badge" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-md"></span>
                </h3>
                
                <form id="form-itinerary" class="space-y-4">
                    <input type="hidden" id="itin-id">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">æ™‚é–“</label>
                            <input type="time" id="itin-time" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-blue-500 outline-none font-mono">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-400 mb-1">åˆ†é¡</label>
                            <select id="itin-category" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-blue-500 outline-none">
                                <option value="spot">ğŸ“¸ æ™¯é»</option>
                                <option value="food">ğŸœ ç¾é£Ÿ</option>
                                <option value="transport">ğŸš† äº¤é€š</option>
                                <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="hotel">ğŸ¨ ä½å®¿</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">æ¨™é¡Œ</label>
                        <input type="text" id="itin-title" placeholder="ä¾‹å¦‚ï¼šå¤ªå®°åºœå¤©æ»¿å®®" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-blue-500 outline-none font-bold text-lg">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">åœ°åœ–é€£çµ (URL)</label>
                        <input type="url" id="itin-url" placeholder="https://goo.gl/maps/..." class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-blue-500 outline-none text-sm text-blue-600">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">å‚™è¨»</label>
                        <textarea id="itin-note" rows="2" placeholder="å‚™è¨»..." class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-blue-500 outline-none"></textarea>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="deleteItinerary()" id="btn-delete-itin" class="hidden px-4 bg-red-50 text-red-500 rounded-xl font-bold">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button type="button" onclick="saveItinerary()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: è¨˜å¸³ -->
    <div id="modal-expense" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal('modal-expense')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full md:max-w-md md:left-1/2 md:-translate-x-1/2" id="sheet-expense">
            <div class="p-6">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4 text-slate-800">è¨˜ä¸€ç­†æ”¯å‡º</h3>
                
                <form class="space-y-4">
                    <div class="flex gap-3">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-slate-400 mb-1">æ—¥æœŸ</label>
                            <select id="exp-day" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 font-bold"></select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">ä»˜æ¬¾äºº</label>
                            <select id="exp-payer" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200"></select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">é‡‘é¡ (JPY)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-slate-400 font-bold">Â¥</span>
                            <input type="number" id="exp-amount" placeholder="0" class="w-full pl-8 p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-yellow-500 outline-none font-mono font-bold text-xl">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">é …ç›®</label>
                        <input type="text" id="exp-item" placeholder="ä¾‹å¦‚ï¼šä¾¿åˆ©å•†åº—" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-yellow-500 outline-none">
                    </div>

                    <button type="button" onclick="saveExpense()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg mt-2">
                        ç¢ºèªè¨˜å¸³
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: è¨­å®š -->
    <div id="modal-settings" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-settings')"></div>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ—…ä¼´åå–® (é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="set-companions" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">åŒ¯ç‡ (JPY â†’ TWD)</label>
                    <input type="number" step="0.001" id="set-rate" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                
                <hr class="border-slate-100 my-2">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">è³‡æ–™åŒæ­¥ (ä»£ç¢¼)</label>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold"><i class="fas fa-copy mr-1"></i>åŒ¯å‡º</button>
                        <button onclick="importData()" class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold"><i class="fas fa-paste mr-1"></i>åŒ¯å…¥</button>
                    </div>
                </div>

                <div class="pt-4 flex justify-between items-center border-t border-slate-100 mt-4">
                    <button onclick="resetData()" class="text-xs text-red-400 underline">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold text-sm">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- è¨­å®šå¸¸æ•¸ ---
        const DAY_LABELS = ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6"];
        const STORAGE_KEY = "fukuoka_v3_data";
        
        // --- é è¨­è³‡æ–™ ---
        const defaultData = {
            items: [
                { id: 1, day: "Day 1", time: "10:00", category: "transport", title: "æŠµé”ç¦å²¡æ©Ÿå ´", url: "", note: "æ­åœ°éµè‡³åšå¤šè»Šç«™" },
                { id: 2, day: "Day 1", time: "12:00", category: "food", title: "åšå¤šæ‹‰éºµ", url: "", note: "ä¸€è˜­ç¸½åº—" }
            ],
            expenses: [],
            settings: {
                companions: ["æˆ‘", "æ—…ä¼´A"],
                rate: 0.215
            }
        };

        // --- ç‹€æ…‹ç®¡ç† ---
        let appData = null;
        let currentTab = 0; // 0 ~ 5 for Days, 6 for Money

        // --- åˆå§‹åŒ– ---
        function init() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    appData = JSON.parse(raw);
                    // ç°¡å–®çš„ç‰ˆæœ¬æª¢æŸ¥æˆ–çµæ§‹è£œå…¨å¯ä»¥æ”¾åœ¨é€™
                    if(!appData.items) appData = defaultData;
                } else {
                    appData = JSON.parse(JSON.stringify(defaultData));
                    saveData();
                }
            } catch (e) {
                console.error("Data corrupted, resetting...", e);
                alert("ç³»çµ±åµæ¸¬åˆ°è³‡æ–™ç•°å¸¸ï¼Œå·²é‡ç½®ç‚ºé è¨­å€¼ã€‚");
                appData = JSON.parse(JSON.stringify(defaultData));
                saveData();
            }

            renderTabs();
            switchTab(0); // é è¨­é¡¯ç¤º Day 1
            startClock();
            fetchWeather();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        // --- UI æ¸²æŸ“ï¼šåˆ†é å°èˆª ---
        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = '';

            // æ¸²æŸ“ Day 1 ~ Day 6
            DAY_LABELS.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.className = `flex-none px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 border border-transparent tab-btn`;
                btn.innerText = day;
                btn.onclick = () => switchTab(index);
                btn.dataset.index = index;
                container.appendChild(btn);
            });

            // æ¸²æŸ“ åˆ†å¸³ Tab (æœ€å¾Œä¸€å€‹)
            const moneyBtn = document.createElement('button');
            moneyBtn.className = `flex-none px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 border border-transparent tab-btn ml-2`;
            moneyBtn.innerHTML = '<i class="fas fa-coins mr-1"></i>åˆ†å¸³';
            moneyBtn.onclick = () => switchTab(6); // 6 ä»£è¡¨åˆ†å¸³é 
            moneyBtn.dataset.index = 6;
            container.appendChild(moneyBtn);
        }

        function switchTab(index) {
            currentTab = index;
            
            // æ›´æ–° Tab æ¨£å¼
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                const btnIndex = parseInt(btn.dataset.index);
                if (btnIndex === index) {
                    if (index === 6) {
                        // åˆ†å¸³é é¸ä¸­æ¨£å¼
                        btn.className = 'flex-none px-4 py-2 rounded-full text-sm font-bold border tab-btn ml-2 bg-yellow-400 text-yellow-900 border-yellow-500 shadow-md transform scale-105';
                    } else {
                        // ä¸€èˆ¬å¤©æ•¸é¸ä¸­æ¨£å¼
                        btn.className = 'flex-none px-4 py-2 rounded-full text-sm font-bold border tab-btn bg-blue-600 text-white border-blue-700 shadow-md transform scale-105';
                    }
                } else {
                    // æœªé¸ä¸­æ¨£å¼
                    if (btnIndex === 6) {
                        btn.className = 'flex-none px-4 py-2 rounded-full text-sm font-bold border tab-btn ml-2 bg-white text-slate-500 border-slate-200';
                    } else {
                        btn.className = 'flex-none px-4 py-2 rounded-full text-sm font-bold border tab-btn bg-white text-slate-500 border-slate-200';
                    }
                }
            });

            // æ»¾å‹• Tab åˆ°å¯è¦‹ç¯„åœ
            const activeBtn = document.querySelector(`button[data-index="${index}"]`);
            if(activeBtn) {
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            // æ›´æ–°å…§å®¹èˆ‡ FAB é¡è‰²
            const fab = document.querySelector('.fab-btn');
            if (index === 6) {
                renderMoney();
                fab.className = fab.className.replace('bg-blue-600', 'bg-slate-800').replace('shadow-blue-500/40', 'shadow-slate-500/40');
            } else {
                renderItinerary(DAY_LABELS[index]);
                fab.className = fab.className.replace('bg-slate-800', 'bg-blue-600').replace('shadow-slate-500/40', 'shadow-blue-500/40');
            }
        }

        // --- é‚è¼¯ï¼šFAB æŒ‰éˆ•é»æ“Š ---
        function handleFabClick() {
            if (currentTab === 6) {
                openExpenseModal();
            } else {
                openItineraryModal();
            }
        }

        // --- åŠŸèƒ½æ¨¡çµ„ï¼šè¡Œç¨‹ (Itinerary) ---
        const categoryIcons = {
            spot: { icon: 'fa-camera', color: 'text-green-500', bg: 'bg-green-100' },
            food: { icon: 'fa-utensils', color: 'text-orange-500', bg: 'bg-orange-100' },
            transport: { icon: 'fa-train', color: 'text-blue-500', bg: 'bg-blue-100' },
            shop: { icon: 'fa-shopping-bag', color: 'text-pink-500', bg: 'bg-pink-100' },
            hotel: { icon: 'fa-bed', color: 'text-purple-500', bg: 'bg-purple-100' }
        };

        function renderItinerary(day) {
            const container = document.getElementById('main-content');
            container.innerHTML = `<div class="h-4"></div>`; // spacer

            // ç¯©é¸ä¸¦æ’åº
            const items = appData.items
                .filter(i => i.day === day)
                .sort((a, b) => a.time.localeCompare(b.time));

            if (items.length === 0) {
                container.innerHTML += `
                    <div class="flex flex-col items-center justify-center mt-20 opacity-40">
                        <i class="fas fa-map-marked-alt text-6xl mb-4 text-slate-300"></i>
                        <p class="text-sm font-bold text-slate-400">å°šç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢</p>
                    </div>
                `;
                return;
            }

            items.forEach(item => {
                const style = categoryIcons[item.category] || categoryIcons.spot;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl p-4 mb-3 shadow-sm border border-slate-100 flex gap-4 relative group active:scale-[0.98] transition-transform';
                
                // é»æ“Šå¡ç‰‡æœ¬é«” -> ç·¨è¼¯
                card.onclick = (e) => {
                    // å¦‚æœé»åˆ°çš„æ˜¯é€£çµæŒ‰éˆ•ï¼Œä¸è§¸ç™¼ç·¨è¼¯
                    if(!e.target.closest('button.nav-btn')) openItineraryModal(item.id); 
                };

                card.innerHTML = `
                    <div class="flex flex-col items-center pt-1 w-12 border-r border-slate-50 pr-2">
                        <span class="text-sm font-bold font-mono text-slate-600">${item.time}</span>
                        <div class="mt-2 w-8 h-8 rounded-full ${style.bg} ${style.color} flex items-center justify-center text-xs">
                            <i class="fas ${style.icon}"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-slate-800 text-lg truncate">${item.title}</h3>
                        ${item.note ? `<p class="text-xs text-slate-400 truncate mt-0.5">${item.note}</p>` : ''}
                        
                        ${item.url ? `
                            <button onclick="window.open('${item.url}', '_blank')" class="nav-btn mt-2 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-blue-100 transition-colors">
                                <i class="fas fa-location-arrow"></i> å°èˆª
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // æ–°å¢/ç·¨è¼¯ Modal
        function openItineraryModal(id = null) {
            const modal = document.getElementById('modal-itinerary');
            const sheet = document.getElementById('sheet-itinerary');
            const form = document.getElementById('form-itinerary');
            
            document.getElementById('itin-modal-day-badge').innerText = DAY_LABELS[currentTab];
            
            if (id) {
                const item = appData.items.find(i => i.id === id);
                document.getElementById('itin-modal-title').innerText = "ç·¨è¼¯è¡Œç¨‹";
                document.getElementById('itin-id').value = item.id;
                document.getElementById('itin-time').value = item.time;
                document.getElementById('itin-category').value = item.category;
                document.getElementById('itin-title').value = item.title;
                document.getElementById('itin-url').value = item.url || '';
                document.getElementById('itin-note').value = item.note || '';
                document.getElementById('btn-delete-itin').classList.remove('hidden');
            } else {
                document.getElementById('itin-modal-title').innerText = "æ–°å¢è¡Œç¨‹";
                form.reset();
                document.getElementById('itin-id').value = '';
                document.getElementById('itin-time').value = "10:00";
                document.getElementById('btn-delete-itin').classList.add('hidden');
            }

            modal.classList.remove('hidden');
            setTimeout(() => sheet.classList.remove('translate-y-full'), 10);
        }

        function saveItinerary() {
            const id = document.getElementById('itin-id').value;
            const data = {
                id: id ? parseInt(id) : Date.now(),
                day: DAY_LABELS[currentTab],
                time: document.getElementById('itin-time').value,
                category: document.getElementById('itin-category').value,
                title: document.getElementById('itin-title').value,
                url: document.getElementById('itin-url').value,
                note: document.getElementById('itin-note').value
            };

            if (!data.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");

            if (id) {
                const idx = appData.items.findIndex(i => i.id == id);
                if (idx > -1) appData.items[idx] = data;
            } else {
                appData.items.push(data);
            }

            saveData();
            closeModal('modal-itinerary');
            renderItinerary(data.day);
        }

        function deleteItinerary() {
            const id = document.getElementById('itin-id').value;
            if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                appData.items = appData.items.filter(i => i.id != id);
                saveData();
                closeModal('modal-itinerary');
                renderItinerary(DAY_LABELS[currentTab]);
            }
        }

        // --- åŠŸèƒ½æ¨¡çµ„ï¼šåˆ†å¸³ (Split Bill) ---
        function renderMoney() {
            const container = document.getElementById('main-content');
            container.innerHTML = `<div class="h-4"></div>`;

            // 1. è¨ˆç®—ç¸½é¡
            let totalJPY = 0;
            appData.expenses.forEach(e => totalJPY += e.amount);
            const totalTWD = Math.round(totalJPY * appData.settings.rate);

            // 2. é ‚éƒ¨çœ‹æ¿
            const board = document.createElement('div');
            board.className = 'bg-slate-800 text-white p-5 rounded-2xl shadow-lg mb-6 mx-1';
            board.innerHTML = `
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-xs text-slate-400 uppercase tracking-wider">ç¸½æ”¯å‡º (ç´„å°å¹£)</p>
                        <h2 class="text-3xl font-mono font-bold">NT$ ${totalTWD.toLocaleString()}</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400">åŒ¯ç‡</p>
                        <p class="font-mono font-bold">${appData.settings.rate}</p>
                    </div>
                </div>
                <div class="pt-4 border-t border-slate-700">
                    <p class="text-xs text-slate-400 mb-2">çµç®—å»ºè­°ï¼š</p>
                    <div id="settlement-result" class="text-sm font-mono text-yellow-400 space-y-1">è¨ˆç®—ä¸­...</div>
                </div>
            `;
            container.appendChild(board);

            // 3. çµç®—é‚è¼¯
            calculateSettlement();

            // 4. æ”¯å‡ºåˆ—è¡¨
            const listHeader = document.createElement('h3');
            listHeader.className = 'font-bold text-slate-500 text-sm px-2 mb-2 uppercase';
            listHeader.innerText = 'æ”¯å‡ºæ˜ç´°';
            container.appendChild(listHeader);

            [...appData.expenses].reverse().forEach(exp => {
                const twd = Math.round(exp.amount * appData.settings.rate);
                const row = document.createElement('div');
                row.className = 'bg-white p-3 rounded-xl border border-slate-200 mb-2 flex justify-between items-center shadow-sm';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-600">
                            ${exp.payer.slice(0,1)}
                        </div>
                        <div>
                            <div class="font-bold text-slate-800">${exp.item}</div>
                            <div class="text-xs text-slate-400">${exp.day} Â· Â¥${exp.amount.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="text-right font-mono font-bold text-slate-700">NT$${twd}</div>
                `;
                
                // é•·æŒ‰åˆªé™¤ (ç°¡å–®å¯¦ä½œï¼šé»æ“Šç¢ºèª)
                row.onclick = () => {
                   if(confirm(`åˆªé™¤é€™ç­†æ”¯å‡ºï¼š${exp.item}?`)) {
                       appData.expenses = appData.expenses.filter(e => e.id !== exp.id);
                       saveData();
                       renderMoney();
                   }
                };
                
                container.appendChild(row);
            });
        }

        function calculateSettlement() {
            const balances = {};
            appData.settings.companions.forEach(p => balances[p] = 0);
            
            // è¨ˆç®—æ¯å€‹äººå¯¦éš›æ”¯ä»˜ vs æ‡‰ä»˜
            appData.expenses.forEach(exp => {
                const twd = Math.round(exp.amount * appData.settings.rate);
                balances[exp.payer] += twd; // ä»–å…ˆå¢Šçš„éŒ¢
                const share = twd / appData.settings.companions.length; // å¹³å‡åˆ†æ”¤
                appData.settings.companions.forEach(p => balances[p] -= share);
            });

            // åª’åˆæ¬ å‚µäººèˆ‡å‚µæ¬Šäºº
            let debtors = [], creditors = [];
            for (const [p, amt] of Object.entries(balances)) {
                if (amt < -1) debtors.push({ p, amt });
                if (amt > 1) creditors.push({ p, amt });
            }

            debtors.sort((a,b) => a.amt - b.amt);
            creditors.sort((a,b) => b.amt - a.amt);

            let html = '';
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debt = Math.abs(debtors[i].amt);
                const credit = creditors[j].amt;
                const settle = Math.min(debt, credit);
                
                html += `<div>${debtors[i].p} â†’ ${creditors[j].p} : $${Math.round(settle)}</div>`;

                debtors[i].amt += settle;
                creditors[j].amt -= settle;
                
                if (Math.abs(debtors[i].amt) < 1) i++;
                if (creditors[j].amt < 1) j++;
            }
            
            if (html === '') html = 'ç›®å‰çµæ¸…';
            const el = document.getElementById('settlement-result');
            if(el) el.innerHTML = html;
        }

        function openExpenseModal() {
            const modal = document.getElementById('modal-expense');
            const sheet = document.getElementById('sheet-expense');
            
            // å¡«å…… Day é¸é …
            const daySel = document.getElementById('exp-day');
            daySel.innerHTML = DAY_LABELS.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // å¡«å…… Payer é¸é …
            const payerSel = document.getElementById('exp-payer');
            payerSel.innerHTML = appData.settings.companions.map(p => `<option value="${p}">${p}</option>`).join('');

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-item').value = '';

            modal.classList.remove('hidden');
            setTimeout(() => sheet.classList.remove('translate-y-full'), 10);
        }

        function saveExpense() {
            const day = document.getElementById('exp-day').value;
            const payer = document.getElementById('exp-payer').value;
            const amount = parseInt(document.getElementById('exp-amount').value);
            const item = document.getElementById('exp-item').value;

            if (!amount || !item) return alert('è«‹å®Œæ•´å¡«å¯«');

            appData.expenses.push({
                id: Date.now(),
                day, payer, amount, item
            });

            saveData();
            closeModal('modal-expense');
            renderMoney();
        }

        // --- è¨­å®šèˆ‡åŒæ­¥ ---
        function openSettings() {
            document.getElementById('set-companions').value = appData.settings.companions.join(',');
            document.getElementById('set-rate').value = appData.settings.rate;
            document.getElementById('modal-settings').classList.remove('hidden');
        }

        function saveSettings() {
            const comps = document.getElementById('set-companions').value.split(',').map(s=>s.trim()).filter(s=>s);
            const rate = parseFloat(document.getElementById('set-rate').value);
            
            if (comps.length < 1) return alert('è‡³å°‘éœ€è¦ä¸€ä½æ—…ä¼´');
            
            appData.settings.companions = comps;
            appData.settings.rate = rate;
            saveData();
            closeModal('modal-settings');
            
            // è‹¥ç•¶å‰åœ¨åˆ†å¸³é ï¼Œåˆ·æ–°ä¹‹
            if (currentTab === 6) renderMoney();
        }

        function resetData() {
            if(confirm("è­¦å‘Šï¼šé€™å°‡æœƒæ¸…ç©ºæ‰€æœ‰è¡Œç¨‹èˆ‡è¨˜å¸³è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function exportData() {
            const json = JSON.stringify(appData);
            const code = btoa(unescape(encodeURIComponent(json)));
            // ç°¡å–® prompt è®“ç”¨æˆ¶è¤‡è£½
            prompt("è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼åˆ†äº«çµ¦æ—…ä¼´ï¼š", code);
        }

        function importData() {
            const code = prompt("è«‹è²¼ä¸Šæ—…ä¼´åˆ†äº«çš„ä»£ç¢¼ï¼š");
            if (code) {
                try {
                    const json = decodeURIComponent(escape(atob(code)));
                    appData = JSON.parse(json);
                    saveData();
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                    location.reload();
                } catch (e) {
                    alert("ä»£ç¢¼ç„¡æ•ˆ");
                }
            }
        }

        // --- é€šç”¨å·¥å…· ---
        function closeModal(id) {
            const modal = document.getElementById(id);
            const sheet = modal.querySelector('div[id^="sheet-"]'); // æ‰¾ bottom sheet
            
            if (sheet) {
                sheet.classList.add('translate-y-full');
            }
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock').innerText = 
                    `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            };
            update();
            setInterval(update, 1000);
        }

        async function fetchWeather() {
            try {
                // ç¦å²¡åº§æ¨™
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5904&longitude=130.4017&current_weather=true&timezone=Asia%2FTokyo');
                const data = await res.json();
                const temp = Math.round(data.current_weather.temperature);
                document.getElementById('weather').innerHTML = `<i class="fas fa-cloud text-blue-300 mr-1"></i>${temp}Â°C`;
            } catch(e) {
                document.getElementById('weather').innerText = "å¤©æ°£ N/A";
            }
        }

        // å•Ÿå‹• App
        init();

    </script>
</body>
</html>
